defmodule <%= @app_module %>.Assets do
  @moduledoc false

  def css do
    <<
      "*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }",
      "body { min-height:100vh; font-family:Outfit,system-ui,sans-serif; background:#0a0a0f; color:#faf5ff; overflow-x:hidden; position:relative; }",
      "body::before { content:''; position:fixed; inset:0; pointer-events:none; background:radial-gradient(120% 80% at 50% 0%,rgba(239,68,68,.09),transparent 55%),radial-gradient(100% 60% at 50% 100%,rgba(245,158,11,.08),transparent 60%); transition:background var(--dp-slow) var(--dp-ease),opacity var(--dp-med) var(--dp-ease); z-index:0; }",
      "body::after { content:''; position:fixed; inset:0; pointer-events:none; background-image:linear-gradient(rgba(255,255,255,.025) 1px,transparent 1px); background-size:100% 3px; opacity:.18; z-index:0; }",
      ":root { --dp-fast:.16s; --dp-med:.32s; --dp-slow:.56s; --dp-ease:cubic-bezier(.2,.8,.2,1); --dp-anticipate:cubic-bezier(.34,.03,.25,1.17); --dp-settle:cubic-bezier(.16,1,.3,1); --dp-elastic:cubic-bezier(.2,.95,.25,1.22); --dp-focus-ring:rgba(245,158,11,.35); }",
      "body[data-route=\"map\"]::before { background:radial-gradient(140% 90% at 78% 8%,rgba(245,158,11,.11),transparent 56%),radial-gradient(120% 80% at 18% 100%,rgba(14,165,233,.08),transparent 62%); }",
      "body[data-route=\"messages\"]::before { background:radial-gradient(130% 90% at 85% 0%,rgba(239,68,68,.11),transparent 54%),radial-gradient(110% 70% at 10% 100%,rgba(168,85,247,.08),transparent 58%); }",
      "body[data-route=\"profile\"]::before,body[data-route=\"profile-view\"]::before { background:radial-gradient(130% 90% at 80% 0%,rgba(234,88,12,.12),transparent 58%),radial-gradient(110% 70% at 20% 100%,rgba(245,158,11,.08),transparent 62%); }",
      "body[data-route=\"tokens\"]::before { background:radial-gradient(130% 95% at 70% 0%,rgba(245,158,11,.14),transparent 58%),radial-gradient(110% 70% at 25% 100%,rgba(239,68,68,.08),transparent 60%); }",
      ":where(a,button,input,select,textarea,[role=\"button\"]):focus-visible { outline:2px solid #f59e0b; outline-offset:2px; box-shadow:0 0 0 3px var(--dp-focus-ring); }",
      "a { color:#f59e0b; text-decoration:none; } a:hover { color:#ef4444; }",

      # Nav
      ".dp-nav { position:sticky; top:0; z-index:100; background:rgba(10,10,15,.92); border-bottom:1px solid #1f1f28; backdrop-filter:blur(12px); }",
      ".dp-nav-inner { max-width:1200px; margin:0 auto; padding:0.5rem 1rem; display:flex; align-items:center; justify-content:space-between; }",
      ".dp-logo { font-weight:800; font-size:1.1rem; background:linear-gradient(135deg,#f59e0b,#ef4444); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }",
      ".dp-nav-links { display:flex; gap:1.25rem; font-size:0.875rem; font-weight:500; align-items:center; }",
      ".dp-nav-links a { color:#9ca3af; transition:color var(--dp-fast),transform var(--dp-fast); position:relative; min-height:44px; display:flex; align-items:center; padding:0.75rem 0; touch-action:manipulation; } .dp-nav-links a:hover { color:#faf5ff; transform:translateY(-1px); }",
      ".dp-nav-links a::after { content:''; position:absolute; left:0; right:0; bottom:0; height:2px; border-radius:999px; background:linear-gradient(90deg,#f59e0b,#ef4444); transform:scaleX(.25); opacity:0; transform-origin:center; transition:transform var(--dp-med) var(--dp-settle),opacity var(--dp-fast); }",
      ".dp-nav-links a.active { color:#f59e0b; }",
      ".dp-nav-links a.active::after { transform:scaleX(1); opacity:1; }",
      ".dp-nav-icon { display:flex; align-items:center; }",
      ".dp-msg-badge:not(:empty) { position:absolute; top:2px; right:-10px; background:#ef4444; color:#fff; font-size:0.65rem; font-weight:700; padding:1px 5px; border-radius:10px; }",
      ".dp-msg-badge.dp-badge-pulse { animation:badge-pulse .6s var(--dp-ease); }",
      ".dp-bottom-nav { display:none; }",
      ".dp-bottom-item { position:relative; min-height:52px; display:flex; align-items:center; justify-content:center; font-size:0.8rem; color:#9ca3af; touch-action:manipulation; border-radius:12px; transition:color var(--dp-fast),transform var(--dp-fast),background-color var(--dp-fast),box-shadow var(--dp-fast); }",
      ".dp-bottom-item::after { content:''; position:absolute; left:18%; right:18%; bottom:7px; height:2px; border-radius:999px; background:linear-gradient(90deg,#f59e0b,#ef4444); transform:scaleX(.2); opacity:0; transition:transform var(--dp-med) var(--dp-settle),opacity var(--dp-fast); }",
      ".dp-bottom-item.active { color:#fff; background:linear-gradient(135deg,rgba(245,158,11,.22),rgba(239,68,68,.2)); box-shadow:0 8px 20px rgba(0,0,0,.32); }",
      ".dp-bottom-item.active::after { transform:scaleX(1); opacity:1; }",
      "@keyframes badge-pulse { 0%{transform:scale(1);} 35%{transform:scale(1.18);} 100%{transform:scale(1);} }",
      "#app { min-height:calc(100vh - 53px); }",
      ".dp-nav,#app,#toast { position:relative; z-index:1; }",
      "#app.dp-route-leave { animation:route-out .2s var(--dp-ease) both; }",
      ".dp-route-shell { min-height:inherit; opacity:0; transform:translateY(18px) scale(0.985); animation:route-in var(--dp-slow) var(--dp-settle) forwards; }",
      ".dp-reveal { opacity:0; transform:translateY(14px) scale(0.985); animation:reveal-in .52s var(--dp-settle) forwards; animation-delay:var(--dp-stagger,0ms); }",
      ".dp-tap-pop { animation:tap-pop .24s var(--dp-anticipate); }",
      ".dp-release-pop { animation:release-pop .26s var(--dp-elastic); }",
      ".dp-count-bump { animation:count-bump .38s var(--dp-anticipate); }",
      "@keyframes route-in { 0%{opacity:0;transform:translateY(18px) scale(0.985);} 62%{opacity:1;transform:translateY(-3px) scale(1.004);} 100%{opacity:1;transform:translateY(0) scale(1);} }",
      "@keyframes route-out { 0%{opacity:1;transform:translateY(0) scale(1);} 100%{opacity:0;transform:translateY(-7px) scale(0.992);} }",
      "@keyframes reveal-in { 0%{opacity:0;transform:translateY(14px) scale(0.985);} 100%{opacity:1;transform:translateY(0) scale(1);} }",
      "@keyframes tap-pop { 0%{transform:scale(1);} 45%{transform:scale(.94,.9);} 100%{transform:scale(1);} }",
      "@keyframes release-pop { 0%{transform:scale(.98,.95);} 65%{transform:scale(1.04,1.03);} 100%{transform:scale(1);} }",
      "@keyframes count-bump { 0%{transform:scale(1);} 44%{transform:scale(1.2);} 100%{transform:scale(1);} }",

      # Hero
      ".dp-hero { position:relative; min-height:100vh; display:flex; align-items:center; justify-content:center; overflow:hidden; background:radial-gradient(ellipse at 50% 80%,#1a0a0a 0%,#0a0a0f 70%); }",
      ".dp-hero-content { position:relative; z-index:2; text-align:center; padding:2rem; max-width:640px; }",
      ".dp-hero-title { font-size:clamp(2.5rem,6vw,4.5rem); font-weight:800; letter-spacing:-0.03em; line-height:1.1; margin-bottom:1.5rem; }",
      ".dp-fire { background:linear-gradient(135deg,#f59e0b,#ef4444,#ea580c); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }",
      ".dp-hero-sub { font-size:1.125rem; color:#9ca3af; max-width:500px; margin:0 auto 2.5rem; line-height:1.7; font-weight:300; }",
      ".dp-hero-cta { display:flex; gap:1rem; justify-content:center; flex-wrap:wrap; }",
      ".dp-btn-lg { padding:1rem 2.5rem; font-size:1rem; border-radius:10px; }",
      ".dp-hero-anim { opacity:0; transform:translateY(24px) scale(0.97); animation:hero-enter .6s var(--dp-settle) forwards; animation-delay:var(--dp-stagger,0ms); }",
      "@keyframes hero-enter { 0%{opacity:0;transform:translateY(24px) scale(0.97);} 65%{opacity:1;transform:translateY(-3px) scale(1.005);} 100%{opacity:1;transform:translateY(0) scale(1);} }",
      # Social proof strip
      ".dp-hero-proof { display:flex; align-items:center; justify-content:center; gap:1.5rem; margin-top:3rem; }",
      ".dp-proof-item { text-align:center; }",
      ".dp-proof-num { display:block; font-size:1.5rem; font-weight:800; color:#f59e0b; }",
      ".dp-proof-label { font-size:0.75rem; color:#6b7280; text-transform:uppercase; letter-spacing:0.06em; }",
      ".dp-proof-sep { width:1px; height:28px; background:#2a2a34; }",

      # Ember particles (enhanced Disney)
      ".dp-embers { position:absolute; inset:0; z-index:1; pointer-events:none; }",
      ".dp-ember { position:absolute; bottom:-10px; border-radius:50%; opacity:0; }",
      ".dp-ember--a { animation:ember-rise-a linear infinite; }",
      ".dp-ember--b { animation:ember-rise-b linear infinite; }",
      ".dp-ember--c { animation:ember-rise-c linear infinite; }",
      "@keyframes ember-rise-a { 0%{transform:translateY(0) translateX(0) scaleY(1);opacity:0;} 8%{opacity:var(--dp-ember-peak,0.8);} 50%{transform:translateY(-50vh) translateX(12px) scaleY(1.3);} 82%{opacity:0.2;} 100%{transform:translateY(-105vh) translateX(-8px) scaleY(0.6);opacity:0;} }",
      "@keyframes ember-rise-b { 0%{transform:translateY(0) translateX(0) scaleY(1);opacity:0;} 10%{opacity:var(--dp-ember-peak,0.7);} 40%{transform:translateY(-40vh) translateX(-15px) scaleY(1.2);} 75%{opacity:0.25;} 100%{transform:translateY(-100vh) translateX(10px) scaleY(0.5);opacity:0;} }",
      "@keyframes ember-rise-c { 0%{transform:translateY(0) translateX(0) scaleY(1);opacity:0;} 12%{opacity:var(--dp-ember-peak,0.9);} 55%{transform:translateY(-55vh) translateX(20px) scaleY(1.5);} 85%{opacity:0.15;} 100%{transform:translateY(-110vh) translateX(-5px) scaleY(0.4);opacity:0;} }",

      # Landing sections
      ".dp-section { padding:6rem 0; }",
      ".dp-section-title { font-size:clamp(1.5rem,4vw,2.25rem); font-weight:800; text-align:center; margin-bottom:3rem; letter-spacing:-0.02em; }",
      # Scroll reveal
      ".dp-scroll-reveal { opacity:0; transform:translateY(20px) scale(0.985); transition:opacity .55s var(--dp-settle),transform .55s var(--dp-settle); }",
      ".dp-scroll-reveal.dp-visible { opacity:1; transform:translateY(0) scale(1); }",

      # How it works
      ".dp-steps { display:flex; align-items:flex-start; justify-content:center; gap:0; max-width:900px; margin:0 auto; }",
      ".dp-step { display:flex; flex-direction:column; align-items:center; text-align:center; flex:1; padding:0 1.25rem; }",
      ".dp-step-num { width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg,#f59e0b,#ef4444); color:#0a0a0f; font-weight:800; font-size:1.25rem; display:flex; align-items:center; justify-content:center; margin-bottom:1.25rem; flex-shrink:0; }",
      ".dp-step-body h3 { font-size:1.1rem; margin-bottom:0.5rem; }",
      ".dp-step-body p { color:#9ca3af; font-size:0.9rem; line-height:1.6; }",
      ".dp-step-line { width:60px; height:2px; background:linear-gradient(90deg,rgba(245,158,11,.4),rgba(239,68,68,.4)); margin-top:26px; flex-shrink:0; }",

      # Safety section
      ".dp-safety { background:linear-gradient(180deg,transparent,rgba(245,158,11,.03) 50%,transparent); }",
      ".dp-safety .dp-grid-2 { max-width:800px; }",

      # Token economy section
      ".dp-token-split { display:grid; grid-template-columns:1fr 1fr; gap:4rem; align-items:center; max-width:900px; margin:0 auto; }",
      ".dp-token-copy p { color:#9ca3af; font-size:1rem; line-height:1.7; margin-bottom:1.5rem; }",
      ".dp-token-perks { list-style:none; margin-bottom:2rem; }",
      ".dp-token-perks li { padding:0.5rem 0; padding-left:1.5rem; position:relative; color:#d1d5db; font-size:0.95rem; }",
      ".dp-token-perks li::before { content:''; position:absolute; left:0; top:50%; transform:translateY(-50%); width:8px; height:8px; border-radius:50%; background:linear-gradient(135deg,#f59e0b,#ef4444); }",
      ".dp-token-visual { display:flex; align-items:center; justify-content:center; }",
      ".dp-token-stack { position:relative; width:160px; height:180px; }",
      ".dp-token-coin { position:absolute; left:50%; transform:translateX(-50%); width:120px; height:120px; border-radius:50%; border:3px solid; }",
      ".dp-token-coin-1 { bottom:0; border-color:#92400e; background:radial-gradient(circle at 40% 40%,#b45309,#78350f); animation:coin-float 3.2s ease-in-out infinite; }",
      ".dp-token-coin-2 { bottom:20px; border-color:#b45309; background:radial-gradient(circle at 40% 40%,#d97706,#92400e); animation:coin-float 3.2s ease-in-out .4s infinite; }",
      ".dp-token-coin-3 { bottom:40px; border-color:#d97706; background:radial-gradient(circle at 40% 40%,#f59e0b,#b45309); animation:coin-float 3.2s ease-in-out .8s infinite; box-shadow:0 0 30px rgba(245,158,11,.3); }",
      ".dp-token-badge { position:absolute; bottom:85px; left:50%; transform:translateX(-50%); background:linear-gradient(135deg,#f59e0b,#ef4444); color:#0a0a0f; font-weight:800; font-size:0.85rem; padding:0.35rem 1rem; border-radius:20px; white-space:nowrap; }",
      "@keyframes coin-float { 0%,100%{transform:translateX(-50%) translateY(0);} 50%{transform:translateX(-50%) translateY(-6px);} }",


      # Final CTA
      ".dp-final-cta { padding:4rem 0 6rem; }",
      ".dp-cta-box { text-align:center; padding:4rem 2rem; border:1px solid; border-image:linear-gradient(145deg,rgba(245,158,11,.4),rgba(239,68,68,.2)) 1; border-radius:0; position:relative; }",
      ".dp-cta-box h2 { font-size:clamp(1.75rem,4vw,2.5rem); font-weight:800; margin-bottom:0.75rem; }",
      ".dp-cta-box p { color:#9ca3af; font-size:1.05rem; margin-bottom:2rem; }",
      ".dp-cta-legal { font-size:0.75rem; color:#6b7280; margin-top:1.5rem; }",

      # Footer full
      ".dp-footer-full { border-top:1px solid #1f1f28; padding:3rem 0 2rem; }",
      ".dp-footer-grid { display:grid; grid-template-columns:2fr 1fr 1fr; gap:2rem; margin-bottom:2rem; }",
      ".dp-footer-brand { font-weight:800; font-size:1.1rem; margin-bottom:0.25rem; }",
      ".dp-footer-tagline { color:#6b7280; font-size:0.9rem; }",
      ".dp-footer-col h4 { font-size:0.8rem; color:#9ca3af; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.75rem; }",
      ".dp-footer-col ul { list-style:none; }",
      ".dp-footer-col li { margin-bottom:0.5rem; }",
      ".dp-footer-col li a { color:#6b7280; font-size:0.875rem; transition:color var(--dp-fast); } .dp-footer-col li a:hover { color:#f59e0b; }",
      ".dp-footer-bottom { display:flex; align-items:center; justify-content:space-between; padding-top:1.5rem; border-top:1px solid #1f1f28; }",
      ".dp-age-badge { display:inline-flex; align-items:center; justify-content:center; width:32px; height:22px; border:1.5px solid #ef4444; border-radius:4px; font-size:0.7rem; font-weight:700; color:#ef4444; }",

      # Buttons
      ".dp-btn { display:inline-block; min-height:44px; padding:0.75rem 2rem; border-radius:8px; font-weight:600; font-size:0.9rem; font-family:inherit; cursor:pointer; transition:transform var(--dp-fast) var(--dp-ease),filter var(--dp-fast) var(--dp-ease),color var(--dp-fast),border-color var(--dp-fast),background-color var(--dp-fast),box-shadow var(--dp-med) var(--dp-settle); border:none; touch-action:manipulation; }",
      ".dp-btn-fire { background:linear-gradient(135deg,#f59e0b,#ef4444); color:#0a0a0f; box-shadow:0 8px 22px rgba(239,68,68,.25); } .dp-btn-fire:hover { filter:brightness(1.15); transform:translateY(-1px); box-shadow:0 12px 26px rgba(239,68,68,.32); }",
      ".dp-btn-ghost { border:1px solid #333; color:#faf5ff; background:transparent; } .dp-btn-ghost:hover { border-color:#f59e0b; color:#f59e0b; }",
      ".dp-btn-full { width:100%; text-align:center; }",
      ".dp-btn-sm { min-height:44px; padding:0.5rem 1rem; font-size:0.8rem; }",
      ".dp-btn-danger { color:#ef4444; border-color:#ef4444; } .dp-btn-danger:hover { background:rgba(239,68,68,.1); }",
      ".dp-btn:disabled { opacity:0.5; cursor:not-allowed; }",
      ".dp-btn[data-busy=\"true\"] { filter:saturate(0.75); box-shadow:none; }",
      ".dp-btn-primary-pulse { animation:primary-breathe 2.4s ease-in-out infinite; }",
      ".dp-btn:active,.dp-map-btn:active { transform:translateY(1px) scale(0.96,0.92); }",
      "@keyframes primary-breathe { 0%,100%{transform:translateY(0) scale(1);} 45%{transform:translateY(-1px) scale(1.03);} }",

      # Cards & sections
      ".dp-container { max-width:1200px; margin:0 auto; padding:0 1.5rem; }",
      ".dp-page { padding-top:2rem; padding-bottom:4rem; }",
      ".dp-page h1 { margin-bottom:1.5rem; }",
      ".dp-center { text-align:center; }",
      ".dp-grid-3 { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1.5rem; }",
      ".dp-grid-2 { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:1.5rem; max-width:720px; margin:0 auto; }",
      ".dp-grid-2-sm { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1.25rem; }",
      ".dp-card { background:#141418; border:1px solid #1f1f28; border-radius:12px; padding:2rem; transition:border-color var(--dp-med),box-shadow var(--dp-med),transform var(--dp-med) var(--dp-settle); transform:translateY(0); }",
      ".dp-card:hover { border-color:#92400e; box-shadow:0 0 34px rgba(234,88,12,.12); transform:translateY(-3px) scale(1.01); }",
      ".dp-card-icon { color:#f59e0b; margin-bottom:1rem; }",
      ".dp-card h3 { font-size:1.1rem; font-weight:700; margin-bottom:0.5rem; }",
      ".dp-card p { color:#9ca3af; font-size:0.9rem; line-height:1.6; }",

      # Features section
      ".dp-features { padding:6rem 0; }",

      # Footer
      ".dp-footer { padding:3rem 0; border-top:1px solid #1f1f28; text-align:center; }",
      ".dp-muted { color:#9ca3af; font-size:0.875rem; }",
      ".dp-empty { padding:3rem 0; text-align:center; }",

      # Auth pages
      ".dp-auth-page { min-height:calc(100vh - 53px); display:flex; align-items:center; justify-content:center; padding:1rem; }",
      ".dp-auth-card { background:linear-gradient(#141418,#141418) padding-box,linear-gradient(145deg,rgba(245,158,11,.35),rgba(239,68,68,.14)) border-box; border:1px solid transparent; border-radius:16px; padding:3rem; width:100%; max-width:420px; box-shadow:0 18px 36px rgba(0,0,0,.36); }",
      ".dp-auth-brand { text-align:center; font-weight:800; letter-spacing:.01em; margin-bottom:0.75rem; }",
      ".dp-auth-card h1 { font-size:1.75rem; font-weight:800; margin-bottom:2rem; text-align:center; }",
      ".dp-auth-alt { text-align:center; margin-top:1rem; color:#9ca3af; font-size:0.875rem; }",
      ".dp-auth-links { margin-top:1.5rem; }",
      ".dp-auth-links .dp-auth-alt { margin-top:0.5rem; }",
      # Field wrapper + inline errors
      ".dp-field { position:relative; }",
      ".dp-field-error { display:block; min-height:1.1rem; font-size:0.78rem; color:#ef4444; padding-top:0.25rem; transition:opacity var(--dp-fast); }",
      ".dp-field-error:empty { opacity:0; }",
      # Password toggle
      ".dp-input-wrap { position:relative; }",
      ".dp-input-wrap .dp-input { padding-right:2.75rem; }",
      ".dp-pw-toggle { position:absolute; right:0.5rem; top:50%; transform:translateY(-50%); background:none; border:none; color:#6b7280; cursor:pointer; padding:0.5rem; display:flex; align-items:center; transition:color var(--dp-fast); }",
      ".dp-pw-toggle:hover { color:#f59e0b; }",
      ".dp-pw-toggle.dp-pw-visible { color:#f59e0b; }",
      # Password strength
      ".dp-pw-strength { height:4px; background:#1f1f28; border-radius:4px; margin-top:0.5rem; overflow:hidden; }",
      ".dp-pw-strength-bar { height:100%; width:0%; border-radius:4px; transition:width var(--dp-med) var(--dp-ease),background-color var(--dp-med); }",
      ".dp-pw-strength[data-level=\"weak\"] .dp-pw-strength-bar { width:33%; background:#ef4444; }",
      ".dp-pw-strength[data-level=\"fair\"] .dp-pw-strength-bar { width:66%; background:#f59e0b; }",
      ".dp-pw-strength[data-level=\"strong\"] .dp-pw-strength-bar { width:100%; background:#22c55e; }",
      # Checkbox group (terms/age)
      ".dp-terms-group { margin-top:0.5rem; display:flex; flex-direction:column; gap:0.75rem; }",
      ".dp-check { display:flex; align-items:flex-start; gap:0.75rem; cursor:pointer; font-size:0.85rem; color:#d1d5db; line-height:1.5; }",
      ".dp-check input { position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; }",
      ".dp-check-box { width:22px; height:22px; border:2px solid #333; border-radius:6px; flex-shrink:0; position:relative; transition:border-color var(--dp-fast),background var(--dp-fast),transform var(--dp-fast); margin-top:1px; }",
      ".dp-check-box::after { content:''; position:absolute; top:3px; left:6px; width:6px; height:10px; border:solid #0a0a0f; border-width:0 2px 2px 0; transform:rotate(45deg) scale(0); transition:transform .2s var(--dp-elastic); }",
      ".dp-check input:checked+.dp-check-box { background:linear-gradient(135deg,#f59e0b,#ef4444); border-color:transparent; transform:scale(1.05); }",
      ".dp-check input:checked+.dp-check-box::after { transform:rotate(45deg) scale(1); }",
      ".dp-check a { color:#f59e0b; }",
      # Validation shake
      "@keyframes field-shake { 0%,100%{transform:translateX(0);} 20%{transform:translateX(-3px);} 40%{transform:translateX(3px);} 60%{transform:translateX(-2px);} 80%{transform:translateX(1px);} }",
      ".dp-shake { animation:field-shake .3s var(--dp-ease); }",
      # Auth error enhanced
      ".dp-error-shake { animation:field-shake .3s var(--dp-ease); }",
      # Location permission prompt
      ".dp-loc-prompt { text-align:center; padding:3rem 2rem; max-width:400px; }",
      ".dp-loc-prompt h2 { font-size:1.5rem; font-weight:800; margin-bottom:1rem; }",
      ".dp-loc-prompt p { color:#9ca3af; line-height:1.6; margin-bottom:1.5rem; }",
      ".dp-loc-benefits { list-style:none; text-align:left; margin:0 auto 2rem; max-width:300px; }",
      ".dp-loc-benefits li { padding:0.5rem 0; padding-left:1.75rem; position:relative; color:#d1d5db; font-size:0.9rem; }",
      ".dp-loc-benefits li::before { content:''; position:absolute; left:0; top:50%; transform:translateY(-50%); width:10px; height:10px; border-radius:50%; background:#22c55e; }",
      ".dp-loc-icon { display:block; margin:0 auto 1.5rem; color:#f59e0b; animation:pin-float 3.6s ease-in-out infinite; }",
      ".dp-loc-success svg { color:#22c55e; }",
      "@keyframes check-draw { 0%{stroke-dashoffset:30;} 100%{stroke-dashoffset:0;} }",
      ".dp-check-anim { stroke-dasharray:30; stroke-dashoffset:30; animation:check-draw .6s var(--dp-settle) forwards; }",

      # Forms
      ".dp-form { display:flex; flex-direction:column; gap:0.75rem; }",
      ".dp-label { font-size:0.8rem; color:#9ca3af; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; margin-top:0.5rem; margin-bottom:-0.375rem; }",
      ".dp-label:first-child { margin-top:0; }",
      ".dp-input { background:#0a0a0f; border:1px solid #1f1f28; border-radius:8px; padding:0.75rem 1rem; color:#faf5ff; font-family:inherit; font-size:0.9rem; outline:none; transition:border-color var(--dp-fast),box-shadow var(--dp-fast); width:100%; }",
      ".dp-input::placeholder { color:#6f7380; }",
      "textarea.dp-input { resize:vertical; }",
      ".dp-input:hover { border-color:#2a2a34; }",
      ".dp-input:focus { border-color:#f59e0b; box-shadow:0 0 0 3px rgba(245,158,11,.16); transform:translateY(-1px); }",
      "input:user-invalid,textarea:user-invalid,select:user-invalid { border-color:#ef4444; box-shadow:0 0 0 2px rgba(239,68,68,.14); }",
      ".dp-input-grow { flex:1; }",
      ".dp-error { color:#ef4444; font-size:0.85rem; margin-top:0.5rem; padding:0.75rem; background:rgba(239,68,68,.1); border-radius:8px; }",
      ".dp-success { color:#22c55e; font-size:0.85rem; margin-top:0.5rem; padding:0.75rem; background:rgba(34,197,94,.1); border-radius:8px; }",
      ".dp-profile-completion { margin:0 0 1rem; padding:0.875rem 1rem; background:#141418; border:1px solid #1f1f28; border-radius:12px; }",
      ".dp-profile-completion-row { display:flex; align-items:center; justify-content:space-between; color:#9ca3af; font-size:0.78rem; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem; }",
      ".dp-progress { width:100%; height:8px; background:#1f1f28; border-radius:999px; overflow:hidden; }",
      ".dp-progress-bar { display:block; height:100%; width:0%; background:linear-gradient(90deg,#f59e0b,#ef4444); transition:width var(--dp-med) var(--dp-ease); }",

      # Map page
      ".dp-map-page { position:relative; height:calc(100vh - 53px); }",
      ".dp-map { width:100%; height:100%; }",
      ".dp-map-controls { position:absolute; top:1rem; right:1rem; z-index:500; display:flex; flex-direction:column; gap:0.5rem; }",
      ".dp-map-btn { width:44px; height:44px; border-radius:10px; border:1px solid #1f1f28; background:#141418; color:#f59e0b; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all var(--dp-fast); touch-action:manipulation; box-shadow:0 8px 18px rgba(0,0,0,.35); }",
      ".dp-map-btn:hover { border-color:#f59e0b; }",
      ".dp-map-btn.active { background:#f59e0b; color:#0a0a0f; }",
      ".dp-geo-status { font-size:0.85rem; color:#cbd5e1; text-align:right; background:rgba(10,10,15,.8); border:1px solid rgba(148,163,184,.2); padding:0.35rem 0.6rem; border-radius:8px; transition:background var(--dp-fast),border-color var(--dp-fast),color var(--dp-fast),transform var(--dp-fast); }",
      ".dp-geo-status.dp-status-live { color:#dcfce7; background:rgba(20,83,45,.45); border-color:rgba(34,197,94,.44); }",
      ".dp-geo-status.dp-status-warn { color:#fde68a; background:rgba(120,53,15,.35); border-color:rgba(245,158,11,.48); }",
      ".dp-geo-status.dp-status-off { color:#cbd5e1; background:rgba(15,23,42,.35); border-color:rgba(148,163,184,.22); }",
      ".dp-avatar-pin { width:36px; height:36px; border-radius:50%; border:2px solid #f59e0b; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.5); cursor:pointer; animation:pin-float 3.6s ease-in-out infinite; }",
      ".dp-avatar-pin img { width:100%; height:100%; object-fit:cover; display:block; }",
      ".dp-avatar-pin-letter { width:36px; height:36px; border-radius:50%; border:2px solid #f59e0b; display:flex; align-items:center; justify-content:center; font-family:Outfit,sans-serif; font-weight:700; font-size:14px; color:#fff; background:linear-gradient(135deg,#92400e,#7c2d12); box-shadow:0 2px 8px rgba(0,0,0,.5); cursor:pointer; animation:pin-float 3.6s ease-in-out infinite; }",
      ".dp-pin-pop { animation:pin-pop .5s var(--dp-anticipate),pin-float 3.6s ease-in-out .45s infinite; }",
      "@keyframes pin-float { 0%,100%{transform:translate3d(0,0,0);} 25%{transform:translate3d(1px,-1px,0);} 50%{transform:translate3d(0,-3px,0);} 75%{transform:translate3d(-1px,-1px,0);} }",
      "@keyframes pin-pop { 0%{transform:translateY(9px) scale(.82);opacity:0;} 65%{transform:translateY(-2px) scale(1.08);opacity:1;} 100%{transform:translateY(0) scale(1);} }",

      # Self-marker pulsing dot (Disney: anticipation, squash/stretch, follow-through, slow in/out)
      ".dp-self-marker { position:relative; width:44px; height:44px; cursor:pointer; }",
      ".dp-self-dot { position:absolute; top:50%; left:50%; width:16px; height:16px; margin:-8px 0 0 -8px; border-radius:50%; background:linear-gradient(135deg,#f59e0b,#ef4444); box-shadow:0 0 12px rgba(245,158,11,.6),0 0 4px rgba(239,68,68,.4); animation:self-pulse 2.8s var(--dp-ease) infinite; z-index:2; }",
      ".dp-self-ring { position:absolute; top:50%; left:50%; width:40px; height:40px; margin:-20px 0 0 -20px; border-radius:50%; border:2px solid rgba(245,158,11,.35); animation:self-ring-pulse 2.8s var(--dp-ease) infinite; z-index:1; }",
      ".dp-self-ring-outer { position:absolute; top:50%; left:50%; width:44px; height:44px; margin:-22px 0 0 -22px; border-radius:50%; background:rgba(245,158,11,.08); animation:self-ring-outer 2.8s var(--dp-ease) infinite; z-index:0; }",
      "@keyframes self-pulse { 0%{transform:scale(1) translateY(0);} 8%{transform:scale(.92,.88) translateY(1px);} 22%{transform:scale(1.18,1.12) translateY(-2px);} 38%{transform:scale(1.04,1.06) translateY(-1px);} 52%{transform:scale(1);} 100%{transform:scale(1);} }",
      "@keyframes self-ring-pulse { 0%{transform:scale(1);opacity:.35;} 8%{transform:scale(.94);opacity:.28;} 22%{transform:scale(1.12);opacity:.55;} 38%{transform:scale(1.02);opacity:.4;} 52%{transform:scale(1);opacity:.35;} 100%{transform:scale(1);opacity:.35;} }",
      "@keyframes self-ring-outer { 0%{transform:scale(1);opacity:.08;} 22%{transform:scale(1.2);opacity:.18;} 50%{transform:scale(1.35);opacity:0;} 100%{transform:scale(1);opacity:0;} }",
      ".dp-self-marker:hover .dp-self-dot { filter:brightness(1.2); }",
      ".dp-self-marker:active .dp-self-dot { transform:scale(.85,.78); animation:none; }",

      # Profile slide-up modal for pin clicks
      ".dp-pin-modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.58); z-index:9998; opacity:0; animation:backdrop-in var(--dp-med) var(--dp-ease) forwards; }",
      ".dp-pin-modal-backdrop.dp-closing { animation:backdrop-out .18s var(--dp-ease) forwards; }",
      ".dp-pin-modal { position:fixed; left:0; right:0; bottom:0; z-index:9999; max-width:440px; margin:0 auto; background:#141418; border:1px solid #1f1f28; border-radius:16px 16px 0 0; box-shadow:0 -20px 60px rgba(0,0,0,.55); transform:translateY(100%); animation:pin-modal-in .42s var(--dp-settle) forwards; overflow:hidden; }",
      ".dp-pin-modal.dp-closing { animation:pin-modal-out .22s var(--dp-ease) forwards; }",
      ".dp-pin-modal-handle { width:44px; height:4px; border-radius:999px; background:#3f3f4b; margin:10px auto 0; }",
      ".dp-pin-modal-avatar { width:72px; height:72px; border-radius:50%; border:3px solid #f59e0b; object-fit:cover; margin:0 auto 0.75rem; display:block; }",
      ".dp-pin-modal-avatar-letter { width:72px; height:72px; border-radius:50%; border:3px solid #f59e0b; display:flex; align-items:center; justify-content:center; margin:0 auto 0.75rem; font-size:1.8rem; font-weight:800; color:#fff; background:linear-gradient(135deg,#92400e,#7c2d12); }",
      ".dp-pin-modal-body { padding:0.75rem 1.25rem 1.25rem; text-align:center; }",
      ".dp-pin-modal-body h3 { font-size:1.15rem; font-weight:700; margin-bottom:0.25rem; }",
      ".dp-pin-modal-body .dp-bio { font-size:0.85rem; color:#9ca3af; margin:0.5rem 0 0.75rem; line-height:1.5; }",
      ".dp-pin-modal-tags { display:flex; flex-wrap:wrap; gap:0.4rem; justify-content:center; margin-bottom:1rem; }",
      ".dp-pin-modal-tag { font-size:0.75rem; padding:0.3rem 0.65rem; border-radius:999px; background:rgba(245,158,11,.1); border:1px solid rgba(245,158,11,.2); color:#f59e0b; }",
      ".dp-pin-modal-actions { display:flex; gap:0.75rem; justify-content:center; padding-bottom:env(safe-area-inset-bottom,0); }",
      ".dp-pin-modal-loading { padding:2rem; display:flex; align-items:center; justify-content:center; }",
      "@keyframes pin-modal-in { 0%{transform:translateY(100%) scale(.96);} 65%{transform:translateY(-8px) scale(1.01);} 100%{transform:translateY(0) scale(1);} }",
      "@keyframes pin-modal-out { 0%{transform:translateY(0) scale(1);opacity:1;} 100%{transform:translateY(60%) scale(.97);opacity:0;} }",
      ".dp-nearby-sheet { position:absolute; left:0; right:0; bottom:0; z-index:550; background:rgba(20,20,24,.96); border-top:1px solid #1f1f28; border-radius:14px 14px 0 0; transform:translateY(calc(100% - 82px)); transition:transform var(--dp-med) var(--dp-settle),box-shadow var(--dp-med) var(--dp-ease); box-shadow:0 -16px 32px rgba(0,0,0,.32); }",
      ".dp-nearby-sheet::before { content:''; position:absolute; top:10px; left:50%; width:44px; height:4px; border-radius:999px; transform:translateX(-50%); background:#3f3f4b; transition:background var(--dp-fast),transform var(--dp-fast); }",
      ".dp-nearby-sheet.open { transform:translateY(0); box-shadow:0 -20px 42px rgba(0,0,0,.45); }",
      ".dp-nearby-sheet.open::before { background:#f59e0b; transform:translateX(-50%) scaleX(1.08); }",
      ".dp-nearby-sheet.dp-sheet-anticipate { transform:translateY(calc(100% - 92px)); }",
      ".dp-nearby-head { display:flex; align-items:center; justify-content:space-between; padding:1.25rem 1rem 0.75rem; cursor:pointer; touch-action:manipulation; }",
      ".dp-nearby-head h2 { font-size:1rem; margin:0; }",
      ".dp-nearby-list { max-height:40vh; overflow:auto; padding:0 0.75rem 0.75rem; }",
      ".dp-nearby-item { display:flex; align-items:center; justify-content:space-between; gap:0.5rem; padding:0.75rem; border-radius:10px; background:linear-gradient(145deg,rgba(28,28,36,.78),rgba(20,20,24,.78)); border:1px solid rgba(52,52,64,.25); transition:background var(--dp-fast),transform var(--dp-fast),border-color var(--dp-fast); }",
      ".dp-nearby-item span { color:#9ca3af; font-size:0.84rem; }",
      ".dp-nearby-item:hover { background:#1a1a21; border-color:#373746; transform:translateX(2px); }",

      # Messages
      ".dp-msg-list { display:flex; flex-direction:column; }",
      ".dp-msg-item { display:flex; align-items:center; gap:0.75rem; padding:1rem; border:1px solid #1f1f28; border-radius:12px; transition:background var(--dp-fast),border-color var(--dp-fast),transform var(--dp-fast); margin-bottom:0.55rem; }",
      ".dp-msg-item:hover { background:#141418; border-color:#2d2d38; transform:translateY(-1px); }",
      ".dp-msg-unread { border-left:3px solid #f59e0b; box-shadow:0 0 0 1px rgba(245,158,11,.15); }",
      ".dp-msg-avatar,.dp-msg-avatar-letter { width:40px; height:40px; border-radius:50%; flex-shrink:0; object-fit:cover; }",
      ".dp-msg-avatar-letter { display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#92400e,#7c2d12); font-weight:700; font-size:16px; color:#fff; }",
      ".dp-msg-body { min-width:0; flex:1; }",
      ".dp-msg-body strong { display:block; font-size:0.9rem; margin-bottom:0.15rem; }",
      ".dp-msg-body span { font-size:0.8rem; color:#9ca3af; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block; }",

      # Conversation
      ".dp-convo { display:flex; flex-direction:column; height:calc(100vh - 53px); }",
      ".dp-convo-header { display:flex; align-items:center; gap:1rem; padding:1rem 0; border-bottom:1px solid #1f1f28; flex-shrink:0; }",
      ".dp-convo-header h2 { flex:1; }",
      ".dp-convo-profile { font-size:0.8rem; color:#9ca3af; }",
      ".dp-back { font-size:1.25rem; color:#9ca3af; } .dp-back:hover { color:#faf5ff; }",
      ".dp-messages { flex:1; overflow-y:auto; padding:1rem 0; display:flex; flex-direction:column; gap:0.5rem; }",
      ".dp-msg-meta { font-size:0.8rem; color:#9ca3af; padding:0.5rem 0 0.25rem; flex-shrink:0; }",
      ".dp-bubble { max-width:70%; padding:0.75rem 1rem; border-radius:12px; font-size:0.9rem; line-height:1.5; transform-origin:bottom center; animation:bubble-in var(--dp-med) var(--dp-ease) forwards; animation-delay:var(--dp-msg-delay,0ms); opacity:0; }",
      ".dp-bubble small { display:flex; align-items:center; gap:0.35rem; font-size:0.7rem; color:#9ca3af; margin-top:0.25rem; }",
      ".dp-bubble-mine { align-self:flex-end; background:linear-gradient(135deg,#92400e,#7c2d12); border-bottom-right-radius:4px; transform-origin:bottom right; }",
      ".dp-bubble-theirs { align-self:flex-start; background:#1f1f28; border-bottom-left-radius:4px; transform-origin:bottom left; }",
      ".dp-bubble-pending { opacity:0.55!important; filter:saturate(0.6); animation:none!important; }",
      ".dp-bubble-confirmed { animation:bubble-confirm .36s var(--dp-elastic) forwards!important; }",
      ".dp-msg-form { display:flex; align-items:flex-end; gap:0.5rem; padding:1rem 0; border-top:1px solid #1f1f28; flex-shrink:0; position:relative; }",
      ".dp-msg-form.dp-send-pending .dp-btn-fire { filter:saturate(0.75); }",
      # Bubble animations - Disney: anticipation, overshoot, settle
      "@keyframes bubble-in { 0%{transform:translateY(8px) scale(0.92);opacity:0;} 55%{transform:translateY(-2px) scale(1.04);opacity:1;} 100%{transform:translateY(0) scale(1);opacity:1;} }",
      "@keyframes bubble-in-sent { 0%{transform:translateX(12px) translateY(6px) scale(0.9);opacity:0;} 55%{transform:translateX(-3px) translateY(-1px) scale(1.03);opacity:1;} 100%{transform:translateX(0) translateY(0) scale(1);opacity:1;} }",
      "@keyframes bubble-in-received { 0%{transform:translateX(-12px) translateY(6px) scale(0.9);opacity:0;} 55%{transform:translateX(3px) translateY(-1px) scale(1.03);opacity:1;} 100%{transform:translateX(0) translateY(0) scale(1);opacity:1;} }",
      "@keyframes bubble-confirm { 0%{opacity:0.55;filter:saturate(0.6);transform:scale(0.98);} 50%{opacity:1;filter:saturate(1);transform:scale(1.03);} 100%{opacity:1;filter:saturate(1);transform:scale(1);} }",
      "@keyframes bubble-prepend { 0%{transform:translateY(-10px);opacity:0;} 100%{transform:translateY(0);opacity:1;} }",
      ".dp-bubble-mine.dp-bubble-new { animation:bubble-in-sent .4s var(--dp-anticipate) forwards; }",
      ".dp-bubble-theirs.dp-bubble-new { animation:bubble-in-received .4s var(--dp-anticipate) forwards; }",
      ".dp-bubble-prepend { animation:bubble-prepend .3s var(--dp-settle) forwards!important; }",
      # Date dividers
      ".dp-msg-date-divider { text-align:center; padding:0.75rem 0 0.5rem; font-size:0.72rem; color:#6f7380; text-transform:uppercase; letter-spacing:0.08em; font-weight:600; position:relative; animation:divider-in .3s var(--dp-ease) forwards; opacity:0; }",
      ".dp-msg-date-divider span { background:#0a0a0f; padding:0 0.75rem; position:relative; z-index:1; }",
      ".dp-msg-date-divider::before { content:''; position:absolute; left:10%; right:10%; top:50%; height:1px; background:#1f1f28; }",
      "@keyframes divider-in { 0%{transform:scale(0.9);opacity:0;} 100%{transform:scale(1);opacity:1;} }",
      # Typing indicator
      ".dp-typing-indicator { align-self:flex-start; display:flex; gap:0.25rem; padding:0.6rem 1rem; background:#1f1f28; border-radius:12px; border-bottom-left-radius:4px; }",
      ".dp-typing-dot { width:7px; height:7px; border-radius:50%; background:#6f7380; animation:typing-bounce .8s var(--dp-elastic) infinite; }",
      ".dp-typing-dot:nth-child(2) { animation-delay:.15s; }",
      ".dp-typing-dot:nth-child(3) { animation-delay:.3s; }",
      "@keyframes typing-bounce { 0%,80%,100%{transform:scale(0.6);opacity:0.4;} 40%{transform:scale(1.2);opacity:1;} 60%{transform:scale(0.85);opacity:0.7;} }",
      # Read receipts
      ".dp-receipt { display:inline-flex; align-items:center; margin-left:0.2rem; animation:receipt-in .2s var(--dp-ease) forwards; opacity:0; }",
      ".dp-receipt-sent { color:#6f7380; }",
      ".dp-receipt-read { color:#f59e0b; }",
      "@keyframes receipt-in { 0%{transform:translateX(3px);opacity:0;} 100%{transform:translateX(0);opacity:1;} }",
      # Media in chat
      ".dp-media-preview { margin-bottom:0.35rem; border-radius:8px; overflow:hidden; max-width:260px; }",
      ".dp-chat-image { display:block; width:100%; max-height:300px; object-fit:cover; border-radius:8px; cursor:pointer; transition:transform var(--dp-fast),filter var(--dp-fast); animation:media-reveal .4s var(--dp-settle) forwards; opacity:0; }",
      ".dp-chat-image:hover { transform:scale(1.02); filter:brightness(1.1); }",
      ".dp-media-shimmer { width:200px; height:150px; border-radius:8px; background:linear-gradient(90deg,#15151b 0%,#1d1d26 45%,#15151b 100%); background-size:220% 100%; animation:shimmer 1.15s linear infinite; }",
      "@keyframes media-reveal { 0%{transform:scale(0.96);opacity:0;} 100%{transform:scale(1);opacity:1;} }",
      # Media upload controls
      ".dp-media-btn { width:40px; height:40px; border-radius:8px; border:1px solid #1f1f28; background:transparent; color:#9ca3af; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:color var(--dp-fast),border-color var(--dp-fast); flex-shrink:0; touch-action:manipulation; }",
      ".dp-media-btn:hover { color:#f59e0b; border-color:#f59e0b; }",
      ".dp-media-preview-strip { display:flex; align-items:center; gap:0.75rem; padding:0.5rem 0.75rem; background:#141418; border:1px solid #1f1f28; border-radius:8px; margin-bottom:0.5rem; }",
      ".dp-media-thumb { width:56px; height:56px; object-fit:cover; border-radius:6px; border:1px solid #2a2a34; }",
      ".dp-media-remove { width:28px; height:28px; border-radius:50%; border:1px solid #333; background:transparent; color:#9ca3af; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:color var(--dp-fast),border-color var(--dp-fast); }",
      ".dp-media-remove:hover { color:#ef4444; border-color:#ef4444; }",
      # Lightbox
      ".dp-lightbox-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.88); display:flex; align-items:center; justify-content:center; z-index:9999; padding:1rem; cursor:pointer; animation:backdrop-in var(--dp-med) var(--dp-ease) forwards; }",
      ".dp-lightbox-backdrop img { max-width:90vw; max-height:90vh; object-fit:contain; border-radius:4px; animation:lightbox-in .35s var(--dp-anticipate) forwards; }",
      ".dp-lightbox-backdrop.dp-closing { animation:backdrop-out .18s var(--dp-ease) forwards; }",
      ".dp-lightbox-backdrop.dp-closing img { animation:lightbox-out .18s var(--dp-ease) forwards; }",
      "@keyframes lightbox-in { 0%{transform:scale(0.85) rotate(-1deg);opacity:0;} 60%{transform:scale(1.02) rotate(0deg);opacity:1;} 100%{transform:scale(1) rotate(0deg);opacity:1;} }",
      "@keyframes lightbox-out { 0%{transform:scale(1);opacity:1;} 100%{transform:scale(0.9);opacity:0;} }",
      # Scroll sentinel & loading
      ".dp-scroll-sentinel { height:1px; width:100%; flex-shrink:0; }",
      ".dp-loading-older { display:flex; justify-content:center; padding:0.75rem 0; flex-shrink:0; }",

      # Tokens
      ".dp-token-stats { display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; margin-bottom:3rem; }",
      ".dp-token-stat { background:#141418; border:1px solid #1f1f28; border-radius:12px; padding:1.5rem; text-align:center; }",
      ".dp-token-val { font-size:2.5rem; font-weight:800; color:#f59e0b; background:linear-gradient(90deg,#f59e0b,#ef4444); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }",
      ".dp-token-label { font-size:0.8rem; color:#9ca3af; margin-top:0.25rem; text-transform:uppercase; letter-spacing:0.05em; }",
      ".dp-token-actions { background:#141418; border:1px solid #1f1f28; border-radius:12px; padding:2rem; }",
      ".dp-token-actions h3 { margin-bottom:0.5rem; }",
      ".dp-token-btns { display:flex; gap:1rem; margin-top:1rem; }",

      # Admin
      ".dp-admin-stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1rem; margin-bottom:3rem; }",
      ".dp-admin-stat { background:#141418; border:1px solid #1f1f28; border-radius:12px; padding:1.5rem; text-align:center; }",
      ".dp-admin-val { font-size:2rem; font-weight:800; color:#f59e0b; }",
      ".dp-admin-label { font-size:0.8rem; color:#9ca3af; margin-top:0.25rem; text-transform:uppercase; letter-spacing:0.05em; }",
      ".dp-table { width:100%; border-collapse:collapse; }",
      ".dp-table th { text-align:left; padding:0.75rem; font-size:0.8rem; color:#9ca3af; text-transform:uppercase; letter-spacing:0.05em; border-bottom:2px solid #1f1f28; }",
      ".dp-table td { padding:0.75rem; font-size:0.875rem; border-bottom:1px solid #1f1f28; }",

      # Profile
      ".dp-profile-card { background:#141418; border:1px solid #1f1f28; border-radius:16px; padding:3rem; text-align:center; max-width:480px; margin:0 auto; }",
      ".dp-profile-avatar { width:96px; height:96px; border-radius:50%; border:3px solid #f59e0b; object-fit:cover; margin-bottom:1rem; }",
      ".dp-profile-avatar-letter { width:96px; height:96px; border-radius:50%; border:3px solid #f59e0b; display:flex; align-items:center; justify-content:center; margin:0 auto 1rem; font-size:2.5rem; font-weight:800; color:#fff; background:linear-gradient(135deg,#92400e,#7c2d12); }",
      ".dp-bio { color:#9ca3af; margin:1rem 0; line-height:1.6; }",
      ".dp-profile-actions { display:flex; gap:0.75rem; justify-content:center; flex-wrap:wrap; margin-top:1.5rem; }",
      ".dp-details { margin:1.5rem 0; text-align:left; }",
      ".dp-detail { display:flex; justify-content:space-between; padding:0.5rem 0; border-bottom:1px solid #1f1f28; font-size:0.875rem; }",
      ".dp-detail-label { color:#9ca3af; }",

      # Settings
      ".dp-settings-section { background:#141418; border:1px solid #1f1f28; border-radius:12px; padding:1.5rem; margin-bottom:1rem; }",
      ".dp-settings-section h3 { margin-bottom:0.75rem; font-size:1rem; }",
      ".dp-toggle { display:flex; align-items:center; gap:0.75rem; cursor:pointer; font-size:0.9rem; min-height:44px; }",
      ".dp-toggle input { position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; }",
      ".dp-toggle-slider { width:44px; height:24px; background:#333; border-radius:12px; position:relative; transition:background var(--dp-fast); flex-shrink:0; }",
      ".dp-toggle-slider::after { content:''; position:absolute; top:2px; left:2px; width:20px; height:20px; background:#faf5ff; border-radius:50%; transition:transform var(--dp-med) var(--dp-elastic); }",
      ".dp-toggle input:checked+.dp-toggle-slider { background:#f59e0b; }",
      ".dp-toggle input:checked+.dp-toggle-slider::after { transform:translateX(20px) scale(1.04); }",

      # Toast notifications
      ".dp-toast { position:fixed; bottom:2rem; left:50%; transform:translateX(-50%); background:#141418; border:1px solid #1f1f28; border-radius:8px; padding:0.75rem 1.5rem; font-size:0.875rem; z-index:9999; box-shadow:0 4px 20px rgba(0,0,0,.4); transition:opacity var(--dp-med),transform var(--dp-med); }",
      ".dp-toast.dp-toast-show { animation:toast-in .4s var(--dp-settle); }",
      ".dp-toast.dp-toast-success { border-color:#22c55e; }",
      ".dp-toast.dp-toast-error { border-color:#ef4444; }",
      "@keyframes toast-in { 0%{opacity:0;transform:translate(-50%,10px) scale(0.97);} 65%{opacity:1;transform:translate(-50%,-2px) scale(1.02);} 100%{opacity:1;transform:translate(-50%,0) scale(1);} }",

      # Modal
      ".dp-modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.68); display:flex; align-items:flex-end; justify-content:center; z-index:9998; padding:1rem; opacity:0; animation:backdrop-in var(--dp-med) var(--dp-ease) forwards; }",
      ".dp-modal-backdrop.dp-closing { animation:backdrop-out .18s var(--dp-ease) forwards; }",
      ".dp-modal { width:100%; max-width:440px; background:#141418; border:1px solid #1f1f28; border-radius:16px; overflow:hidden; box-shadow:0 24px 64px rgba(0,0,0,.55); animation:modal-in var(--dp-med) var(--dp-anticipate); }",
      ".dp-modal.dp-closing { animation:modal-out .18s var(--dp-ease) forwards; }",
      ".dp-modal-head { display:flex; align-items:center; justify-content:space-between; gap:0.75rem; padding:1rem 1rem 0.75rem; border-bottom:1px solid #1f1f28; }",
      ".dp-modal-head h3 { margin:0; font-size:1rem; }",
      ".dp-modal-close { border:1px solid #2b2b36; background:#0a0a0f; color:#9ca3af; width:44px; height:44px; border-radius:10px; cursor:pointer; touch-action:manipulation; }",
      ".dp-modal-body { padding:1rem; }",
      ".dp-modal-body p { color:#9ca3af; line-height:1.5; margin-bottom:0.875rem; }",
      ".dp-report-reasons { display:grid; gap:0.5rem; margin-bottom:0.875rem; }",
      ".dp-reason { display:flex; align-items:flex-start; gap:0.6rem; min-height:44px; padding:0.65rem 0.7rem; border:1px solid #2a2a34; border-radius:10px; cursor:pointer; touch-action:manipulation; }",
      ".dp-reason input { margin-top:0.15rem; accent-color:#f59e0b; }",
      ".dp-reason span { color:#d1d5db; font-size:0.9rem; }",
      ".dp-modal-actions { display:flex; gap:0.75rem; justify-content:flex-end; padding:0 1rem 1rem; }",
      "@keyframes backdrop-in { from{opacity:0;} to{opacity:1;} }",
      "@keyframes backdrop-out { from{opacity:1;} to{opacity:0;} }",
      "@keyframes modal-in { 0%{transform:translateY(34px) scale(0.94);opacity:0;} 65%{transform:translateY(-4px) scale(1.01);opacity:1;} 100%{transform:translateY(0) scale(1);opacity:1;} }",
      "@keyframes modal-out { from{transform:translateY(0) scale(1);opacity:1;} to{transform:translateY(14px) scale(0.98);opacity:0;} }",

      # Loading state
      ".dp-loading { display:flex; align-items:center; justify-content:center; padding:4rem; }",
      ".dp-spinner { width:32px; height:32px; border:3px solid #1f1f28; border-top-color:#f59e0b; border-radius:50%; animation:spin .6s linear infinite; }",
      ".dp-loading-stack { width:min(680px,100%); display:grid; gap:0.75rem; }",
      ".dp-loading-row { height:54px; border-radius:12px; background:linear-gradient(90deg,#15151b 0%,#1d1d26 45%,#15151b 100%); background-size:220% 100%; animation:shimmer 1.15s linear infinite; border:1px solid #1f1f28; }",
      ".dp-loading-row:first-child { height:160px; margin-bottom:0.45rem; }",
      "@keyframes spin { to{transform:rotate(360deg)} }",
      "@keyframes shimmer { from{background-position:100% 0;} to{background-position:-120% 0;} }",

      # Leaflet custom
      ".leaflet-container { background:#0a0a0f !important; }",
      ".leaflet-control-zoom a { background:#141418 !important; color:#faf5ff !important; border-color:#1f1f28 !important; width:44px !important; height:44px !important; line-height:44px !important; }",
      ".leaflet-control-zoom a:hover { background:#1f1f28 !important; color:#f59e0b !important; }",
      ".dp-map-page .leaflet-control-container .leaflet-bottom { bottom:88px; transition:bottom var(--dp-med) var(--dp-ease); }",
      ".dp-map-page.dp-sheet-open .leaflet-control-container .leaflet-bottom { bottom:calc(42vh + 12px); }",
      ".dp-marker-popup { font-family:Outfit,sans-serif; }",
      ".dp-marker-popup strong { color:#f59e0b; }",

      # Empty state enhanced
      ".dp-empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:4rem 1.5rem; text-align:center; }",
      ".dp-empty-state svg { color:#333; margin-bottom:1.5rem; animation:empty-float 3s ease-in-out infinite; }",
      ".dp-empty-state p { color:#9ca3af; font-size:1rem; margin-bottom:1.5rem; line-height:1.6; }",
      ".dp-empty-state .dp-btn-fire { animation:primary-breathe 2.8s ease-in-out infinite; }",
      "@keyframes empty-float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-4px);} }",

      # Grid item labels/inputs block display
      ".dp-grid-2-sm label { display:block; }",
      ".dp-grid-2-sm .dp-input { width:100%; }",
      ".dp-grid-2-sm .dp-label { margin-top:0; }",

      # Form submit button spacing
      ".dp-form .dp-btn { margin-top:1.5rem; }",

      # Settings manage button spacing
      ".dp-settings-section .dp-btn { margin-top:0.75rem; }",

      # Token tiers  balance hero
      ".dp-balance-hero { text-align:center; padding:2.5rem 1rem 1.5rem; background:linear-gradient(180deg,rgba(245,158,11,.06),transparent 80%); border-radius:16px; margin-bottom:2rem; }",
      ".dp-balance-number { font-size:3.5rem; font-weight:800; background:linear-gradient(135deg,#f59e0b,#ef4444); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; line-height:1.1; }",
      ".dp-balance-number.dp-count-overshoot { animation:count-overshoot .5s var(--dp-anticipate); }",
      ".dp-balance-sub { color:#9ca3af; font-size:0.85rem; margin-top:0.35rem; }",
      "@keyframes count-overshoot { 0%{transform:scale(1);} 40%{transform:scale(1.12) translateY(-2px);} 70%{transform:scale(0.97);} 100%{transform:scale(1);} }",

      # Token tiers  daily section
      ".dp-daily-section { background:#141418; border:1px solid #1f1f28; border-radius:12px; padding:1.25rem; margin-bottom:1.5rem; }",
      ".dp-daily-row { display:flex; align-items:center; justify-content:space-between; gap:1rem; }",
      ".dp-daily-left { flex:1; }",
      ".dp-daily-left h3 { font-size:0.95rem; font-weight:600; margin-bottom:0.25rem; }",
      ".dp-daily-left .dp-countdown { font-size:0.8rem; color:#9ca3af; font-variant-numeric:tabular-nums; }",
      ".dp-daily-right { flex-shrink:0; }",

      # Token tiers  tier grid
      ".dp-tier-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; margin-bottom:2rem; }",
      ".dp-tier-card { position:relative; background:#141418; border:2px solid #1f1f28; border-radius:14px; padding:1.5rem 1rem; text-align:center; cursor:pointer; transition:border-color var(--dp-med) var(--dp-ease),transform var(--dp-med) var(--dp-settle),box-shadow var(--dp-med) var(--dp-ease); }",
      ".dp-tier-card:hover { border-color:#92400e; transform:translateY(-2px); box-shadow:0 8px 24px rgba(245,158,11,.1); }",
      ".dp-tier-card.dp-tier-selected { border-color:#f59e0b; box-shadow:0 0 0 2px rgba(245,158,11,.25),0 12px 32px rgba(245,158,11,.15); transform:translateY(-4px) scale(1.02); }",
      ".dp-tier-card.dp-tier-selected::after { content:''; position:absolute; inset:-2px; border-radius:14px; border:2px solid transparent; background:linear-gradient(135deg,rgba(245,158,11,.3),rgba(239,68,68,.2)) border-box; -webkit-mask:linear-gradient(#fff 0 0) padding-box,linear-gradient(#fff 0 0); -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none; }",
      ".dp-tier-badge { position:absolute; top:-10px; left:50%; transform:translateX(-50%); font-size:0.65rem; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; padding:0.2rem 0.65rem; border-radius:999px; color:#0a0a0f; white-space:nowrap; }",
      ".dp-tier-badge-popular { background:linear-gradient(135deg,#f59e0b,#ea580c); }",
      ".dp-tier-badge-best { background:linear-gradient(135deg,#ef4444,#dc2626); }",
      ".dp-tier-name { font-size:1.1rem; font-weight:700; margin-bottom:0.5rem; }",
      ".dp-tier-tokens { font-size:2rem; font-weight:800; color:#f59e0b; line-height:1.2; }",
      ".dp-tier-tokens small { font-size:0.85rem; color:#9ca3af; font-weight:400; }",
      ".dp-tier-price { font-size:1rem; font-weight:600; color:#d1d5db; margin-top:0.35rem; }",
      ".dp-tier-rate { font-size:0.75rem; color:#6b7280; margin-top:0.2rem; }",
      "@keyframes tier-select { 0%{transform:translateY(-4px) scale(1.02);} 35%{transform:translateY(-6px) scale(1.05);} 100%{transform:translateY(-4px) scale(1.02);} }",
      ".dp-tier-card.dp-tier-just-selected { animation:tier-select .35s var(--dp-anticipate); }",

      # Token tiers  heading + labels
      ".dp-tier-heading { font-size:1.25rem; font-weight:700; margin-bottom:0.35rem; }",
      ".dp-tier-sub { margin-bottom:1.25rem; }",
      ".dp-tier-tokens-label { font-size:0.78rem; color:#9ca3af; text-transform:uppercase; letter-spacing:0.04em; margin-top:0.1rem; }",
      ".dp-tier-action { text-align:center; margin-bottom:2rem; }",

      # Token tiers  buy button area
      ".dp-buy-area { text-align:center; margin-bottom:2rem; }",
      ".dp-buy-area .dp-btn { min-width:220px; }",

      # Token tiers  transaction history
      ".dp-txn-section { background:#141418; border:1px solid #1f1f28; border-radius:12px; overflow:hidden; }",
      ".dp-txn-header { display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem; border-bottom:1px solid #1f1f28; cursor:pointer; }",
      ".dp-txn-header h3 { font-size:0.95rem; font-weight:600; margin:0; }",
      ".dp-txn-header svg { transition:transform var(--dp-fast); }",
      ".dp-txn-header.dp-txn-open svg { transform:rotate(180deg); }",
      ".dp-txn-body { max-height:0; overflow:hidden; transition:max-height var(--dp-med) var(--dp-ease); }",
      ".dp-txn-body.dp-txn-visible { max-height:400px; overflow-y:auto; }",
      ".dp-txn-row { display:flex; align-items:center; justify-content:space-between; padding:0.65rem 1.25rem; border-bottom:1px solid rgba(31,31,40,.5); font-size:0.85rem; }",
      ".dp-txn-row:last-child { border-bottom:none; }",
      ".dp-txn-type { color:#9ca3af; }",
      ".dp-txn-amount { font-weight:600; font-variant-numeric:tabular-nums; }",
      ".dp-txn-amount.dp-txn-plus { color:#22c55e; }",
      ".dp-txn-amount.dp-txn-minus { color:#ef4444; }",
      ".dp-txn-date { color:#6b7280; font-size:0.75rem; margin-left:0.75rem; }",
      "@keyframes purchase-success { 0%{transform:scale(1);} 30%{transform:scale(1.06);} 55%{transform:scale(0.97);} 100%{transform:scale(1);} }",
      ".dp-purchase-success { animation:purchase-success .5s var(--dp-anticipate); }",

      # Filter panel
      ".dp-filter-panel { position:fixed; top:0; right:0; bottom:0; width:320px; max-width:85vw; z-index:9900; background:#0f0f14; border-left:1px solid #1f1f28; box-shadow:-12px 0 40px rgba(0,0,0,.5); transform:translateX(100%); transition:transform var(--dp-med) var(--dp-settle); overflow-y:auto; }",
      ".dp-filter-panel.dp-filter-open { transform:translateX(0); }",
      ".dp-filter-backdrop { position:fixed; inset:0; z-index:9899; background:rgba(0,0,0,.5); opacity:0; transition:opacity var(--dp-med); pointer-events:none; }",
      ".dp-filter-backdrop.dp-filter-open { opacity:1; pointer-events:auto; }",
      ".dp-filter-header { display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem; border-bottom:1px solid #1f1f28; }",
      ".dp-filter-header h3 { font-size:1rem; font-weight:700; margin:0; }",
      ".dp-filter-close { width:36px; height:36px; border-radius:8px; border:1px solid #2a2a34; background:transparent; color:#9ca3af; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:1.2rem; }",
      ".dp-filter-section { padding:1rem 1.25rem; border-bottom:1px solid rgba(31,31,40,.5); }",
      ".dp-filter-section h4 { font-size:0.78rem; color:#9ca3af; text-transform:uppercase; letter-spacing:0.06em; margin-bottom:0.75rem; }",
      ".dp-filter-count { position:absolute; top:-4px; right:-6px; min-width:18px; height:18px; font-size:0.6rem; font-weight:700; display:flex; align-items:center; justify-content:center; background:#ef4444; color:#fff; border-radius:999px; padding:0 4px; }",
      ".dp-filter-actions { padding:1rem 1.25rem; display:flex; gap:0.75rem; }",
      ".dp-filter-actions .dp-btn { flex:1; }",

      # Filter controls  segments
      ".dp-segment-group { display:flex; gap:0.35rem; flex-wrap:wrap; }",
      ".dp-segment { padding:0.45rem 0.85rem; font-size:0.8rem; border-radius:999px; border:1px solid #2a2a34; background:transparent; color:#9ca3af; cursor:pointer; font-family:inherit; transition:all var(--dp-fast) var(--dp-ease); }",
      ".dp-segment:hover { border-color:#92400e; color:#d1d5db; }",
      ".dp-segment.dp-seg-active { background:linear-gradient(135deg,rgba(245,158,11,.2),rgba(239,68,68,.15)); border-color:#f59e0b; color:#f59e0b; animation:pill-pop .25s var(--dp-anticipate); }",
      "@keyframes pill-pop { 0%{transform:scale(1);} 40%{transform:scale(1.08);} 100%{transform:scale(1);} }",

      # Filter controls  range slider
      ".dp-range-group { margin:0.5rem 0; }",
      ".dp-range-labels { display:flex; justify-content:space-between; font-size:0.78rem; color:#9ca3af; margin-bottom:0.5rem; }",
      ".dp-range-track { position:relative; width:100%; height:6px; background:#1f1f28; border-radius:999px; }",
      ".dp-range-fill { position:absolute; top:0; height:100%; background:linear-gradient(90deg,#f59e0b,#ef4444); border-radius:999px; pointer-events:none; }",
      ".dp-range-track input[type=range] { position:absolute; top:-6px; width:100%; height:18px; -webkit-appearance:none; appearance:none; background:transparent; pointer-events:none; margin:0; }",
      ".dp-range-track input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:#faf5ff; border:2px solid #f59e0b; box-shadow:0 2px 6px rgba(0,0,0,.4); pointer-events:auto; cursor:pointer; transition:transform var(--dp-fast),box-shadow var(--dp-fast); }",
      ".dp-range-track input[type=range]::-webkit-slider-thumb:hover { transform:scale(1.15); box-shadow:0 2px 10px rgba(245,158,11,.4); }",

      # Filter controls  checkbox pills
      ".dp-pill-group { display:flex; flex-wrap:wrap; gap:0.35rem; }",
      ".dp-check-pill { display:inline-flex; align-items:center; gap:0.35rem; padding:0.4rem 0.75rem; font-size:0.8rem; border-radius:999px; border:1px solid #2a2a34; background:transparent; color:#9ca3af; cursor:pointer; font-family:inherit; transition:all var(--dp-fast) var(--dp-ease); user-select:none; }",
      ".dp-check-pill input { display:none; }",
      ".dp-check-pill.dp-pill-active { background:linear-gradient(135deg,rgba(245,158,11,.18),rgba(239,68,68,.12)); border-color:#f59e0b; color:#f59e0b; animation:pill-pop .25s var(--dp-anticipate); }",

      # Filter panel slide animation
      "@keyframes filter-slide-in { 0%{transform:translateX(100%) scale(0.98);} 65%{transform:translateX(-6px) scale(1.005);} 100%{transform:translateX(0) scale(1);} }",
      ".dp-filter-panel.dp-filter-entering { animation:filter-slide-in .38s var(--dp-settle) forwards; }",

      # Responsive
      "@media(max-width:768px){",
        "body{padding-bottom:84px;}",
        ".dp-page{padding-bottom:5.5rem;}",
        ".dp-token-stats{grid-template-columns:repeat(3,1fr);}",
        ".dp-token-stat{padding:1rem;}",
        ".dp-token-stats{margin-bottom:1.5rem;}",
        ".dp-nav-links{display:none;}",
        ".dp-bottom-nav{display:grid;grid-template-columns:repeat(5,1fr);gap:0.25rem;position:fixed;left:0;right:0;bottom:0;z-index:120;background:rgba(10,10,15,.94);border-top:1px solid #1f1f28;backdrop-filter:blur(14px);padding:0.35rem max(0.55rem,env(safe-area-inset-left)) calc(0.4rem + env(safe-area-inset-bottom)) max(0.55rem,env(safe-area-inset-right));}",
        ".dp-bottom-item{font-size:0.76rem;min-height:48px;}",
        ".dp-auth-card{padding:2rem 1.25rem;}",
        ".dp-grid-2-sm{grid-template-columns:1fr;}",
        ".dp-token-btns{flex-direction:column;}",
        ".dp-token-btns .dp-btn{width:100%;}",
        ".dp-admin-stats{grid-template-columns:repeat(2,1fr);}",
        ".dp-map-page{height:calc(100vh - 53px - 84px);}",
        ".dp-convo{height:calc(100vh - 53px - 84px);}",
        # Landing responsive
        ".dp-steps{flex-direction:column;gap:1.5rem;}",
        ".dp-step-line{width:2px;height:32px;margin:0 auto;}",
        ".dp-token-split{grid-template-columns:1fr;gap:2rem;}",
        ".dp-token-copy .dp-section-title{text-align:center;}",
        ".dp-token-visual{order:-1;}",
        ".dp-tier-grid{grid-template-columns:1fr;gap:0.75rem;}",
        ".dp-tier-card{padding:1.25rem 1rem;}",
        ".dp-balance-number{font-size:2.5rem;}",
        ".dp-filter-panel{width:100%;max-width:100vw;border-left:none;border-radius:16px 16px 0 0;top:auto;bottom:0;max-height:85vh;transform:translateY(100%);}",
        ".dp-filter-panel.dp-filter-open{transform:translateY(0);}",
        ".dp-footer-grid{grid-template-columns:1fr;gap:1.5rem;text-align:center;}",
        ".dp-footer-bottom{flex-direction:column;gap:0.75rem;text-align:center;}",
        ".dp-hero-proof{flex-wrap:wrap;gap:1rem;}",
        ".dp-proof-sep{display:none;}",
        ".dp-section{padding:4rem 0;}",
        ".dp-cta-box{padding:3rem 1.5rem;}",
      "}",
      "@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation:none!important;transition:none!important;}}"
    >>
  end

  def js do
    <<
      "!function(){",
        "'use strict';",
        "var $=document.getElementById.bind(document),app=$('app');",
        "if(!app)return;",
        "var AUTH=window.__AUTH__,ROUTE=window.__ROUTE__||'landing';",
        "var mapInst=null,markers={},geoWatchId=null,geoEnabled=true,selfMarker=null,selfLatLng=null;",
        "var pollTimer=null,pollInterval=5000,unreadTimer=null,countdownIv=null;",
        "var currentRoute='',formLoadTime=Date.now(),mouseEntropy=0,mouseMoves=0,lastUnreadCount=0,routeToken=0,sheetPrimed=false;",

        # Behavioral tracking for anti-spam
        "document.addEventListener('mousemove',function(){mouseMoves++;mouseEntropy=Math.min(mouseMoves/10,100)});",

        "function wait(ms){return new Promise(function(resolve){setTimeout(resolve,ms);});}",

        "function replayAnimation(el,cls){if(!el)return;el.classList.remove(cls);void el.offsetWidth;el.classList.add(cls);}",

        "function applyStagger(scope){",
          "if(!scope)return;",
          "var nodes=scope.querySelectorAll('h1,h2,.dp-card,.dp-auth-card,.dp-profile-completion,.dp-form > *,.dp-msg-item,.dp-token-stat,.dp-token-actions,.dp-settings-section,.dp-profile-card,.dp-detail,.dp-nearby-item,.dp-empty-state,.dp-admin-stat,.dp-table,.dp-convo-header,.dp-msg-form');",
          "nodes.forEach(function(node,idx){",
            "node.classList.add('dp-reveal');",
            "node.style.setProperty('--dp-stagger',String(Math.min(idx,14)*44)+'ms');",
          "});",
        "}",

        "function applyTapFeedback(){",
          "document.addEventListener('pointerdown',function(e){",
            "var target=e.target&&e.target.closest?e.target.closest('.dp-btn,.dp-map-btn,.dp-nearby-item,.dp-nearby-head,.dp-msg-item,.dp-bottom-item,.dp-nav-links a,.dp-reason,.dp-modal-close'):null;",
            "if(!target)return;",
            "if(target.hasAttribute('disabled')||target.getAttribute('aria-disabled')==='true')return;",
            "replayAnimation(target,'dp-tap-pop');",
          "});",
          "document.addEventListener('pointerup',function(e){",
            "var target=e.target&&e.target.closest?e.target.closest('.dp-btn,.dp-map-btn,.dp-bottom-item,.dp-nav-links a'):null;",
            "if(!target)return;",
            "replayAnimation(target,'dp-release-pop');",
          "});",
        "}",

        "function setButtonBusy(btn,on,label){",
          "if(!btn)return;",
          "if(on){",
            "btn.disabled=true;",
            "btn.setAttribute('data-busy','true');",
            "btn.setAttribute('aria-busy','true');",
            "btn.setAttribute('data-label',btn.textContent||'');",
            "if(label)btn.textContent=label;",
          "}else{",
            "btn.disabled=false;",
            "btn.removeAttribute('data-busy');",
            "btn.removeAttribute('aria-busy');",
            "var prev=btn.getAttribute('data-label');",
            "if(prev){btn.textContent=prev;btn.removeAttribute('data-label');}",
          "}",
        "}",

        "function setGeoStatus(text,state){",
          "var st=$('geo-status');if(!st)return;",
          "st.textContent=text||'';",
          "st.classList.remove('dp-status-live','dp-status-warn','dp-status-off');",
          "if(state==='live')st.classList.add('dp-status-live');",
          "else if(state==='warn')st.classList.add('dp-status-warn');",
          "else st.classList.add('dp-status-off');",
        "}",

        # Toast notification
        "function toast(msg,type){",
          "var t=$('toast');if(!t)return;",
          "t.textContent=msg;t.className='dp-toast'+(type?' dp-toast-'+type:'');",
          "t.style.display='block';",
          "replayAnimation(t,'dp-toast-show');",
          "setTimeout(function(){",
            "t.classList.remove('dp-toast-show');",
            "setTimeout(function(){t.style.display='none';},180);",
          "},2600);",
        "}",

        # SPA Router
        "function navigate(path,push){",
          "if(push!==false)history.pushState(null,null,path);",
          "var route=pathToRoute(path);",
          "loadRoute(route,path);",
        "}",

        "function pathToRoute(p){",
          "if(p==='/'||p==='')return AUTH?'map':'landing';",
          "if(p==='/login')return'login';",
          "if(p==='/signup')return'signup';",
          "if(p==='/app')return'map';",
          "if(p==='/profile')return'profile';",
          "if(p.indexOf('/profile/')===0)return'profile-view';",
          "if(p==='/messages')return'messages';",
          "if(p.indexOf('/messages/')===0)return'conversation';",
          "if(p==='/tokens')return'tokens';",
          "if(p==='/admin')return'admin';",
          "if(p==='/settings')return'settings';",
          "return AUTH?'map':'landing';",
        "}",

        "function fragPath(path){",
          "var r=pathToRoute(path);",
          "if(r==='landing')return'/_fragment/landing';",
          "if(r==='login')return'/_fragment/login';",
          "if(r==='signup')return'/_fragment/signup';",
          "if(r==='map')return'/_fragment/map';",
          "if(r==='profile')return'/_fragment/profile';",
          "if(r==='profile-view')return'/_fragment'+path;",
          "if(r==='messages')return'/_fragment/messages';",
          "if(r==='conversation')return'/_fragment'+path;",
          "if(r==='tokens')return'/_fragment/tokens';",
          "if(r==='admin')return'/_fragment/admin';",
          "if(r==='settings')return'/_fragment/settings';",
          "return'/_fragment/landing';",
        "}",

        "async function loadRoute(route,path){",
          "if(route===currentRoute&&route!=='conversation'&&route!=='profile-view')return;",
          "var token=++routeToken;",
          "if(currentRoute){",
            "app.classList.remove('dp-route-leave');",
            "void app.offsetWidth;",
            "app.classList.add('dp-route-leave');",
            "await wait(140);",
            "if(token!==routeToken)return;",
          "}",
          "cleanupRoute();",
          "currentRoute=route;",
          "updateNav(route);",
          "formLoadTime=Date.now();",
          "mouseMoves=0;mouseEntropy=0;",
          "app.classList.remove('dp-route-leave');",
          "app.innerHTML='<div class=\"dp-loading\"><div class=\"dp-loading-stack\"><div class=\"dp-loading-row\"></div><div class=\"dp-loading-row\"></div><div class=\"dp-loading-row\"></div><div class=\"dp-loading-row\"></div></div></div>';",
          "try{",
            "var fp=fragPath(path);",
            "var r=await fetch(fp);",
            "if(r.status===401){navigate('/login');return;}",
            "if(r.status===403){app.innerHTML='<div class=\"dp-container dp-page dp-center\"><h1>Access denied</h1><p class=\"dp-muted\">You don\\'t have permission to view this page.</p><a href=\"/app\" class=\"dp-btn dp-btn-ghost\" data-nav>Back to map</a></div>';return;}",
            "if(!r.ok){app.innerHTML='<div class=\"dp-container dp-page dp-center\"><h1>Error</h1><p class=\"dp-muted\">Something went wrong ('+r.status+')</p><a href=\"/app\" class=\"dp-btn dp-btn-ghost\" data-nav>Back to map</a></div>';return;}",
            "var html=await r.text();",
            "if(token!==routeToken)return;",
            "app.innerHTML='<div class=\"dp-route-shell\">'+html+'</div>';",
            "initRoute(route);",
            "applyStagger(app.firstElementChild);",
          "}catch(e){",
            "app.innerHTML='<div class=\"dp-container dp-page dp-center\"><h1>Error</h1><p class=\"dp-muted\">Failed to load page</p></div>';",
          "}",
        "}",

        "function cleanupRoute(){",
          "if(pollTimer){clearInterval(pollTimer);pollTimer=null;}",
          "if(countdownIv){clearInterval(countdownIv);countdownIv=null;}",
          "if(mapInst){mapInst.remove();mapInst=null;markers={};selfMarker=null;selfLatLng=null;}",
          "if(geoWatchId){navigator.geolocation.clearWatch(geoWatchId);geoWatchId=null;}",
        "}",

        "function updateNav(route){",
          "var links=document.querySelectorAll('[data-route]');",
          "links.forEach(function(l){",
            "l.classList.toggle('active',l.getAttribute('data-route')===route);",
          "});",
          "document.body.setAttribute('data-route',route||'landing');",
        "}",

        # Route initializers
        "function initRoute(route){",
          "if(route==='landing'){initEmbers();initScrollReveal();initLandingCounters();initAgeGateLinks();}",
          "if(route==='login')initLogin();",
          "if(route==='signup')initSignup();",
          "if(route==='map')initMap();",
          "if(route==='messages')initMessagesList();",
          "if(route==='profile')initProfile();",
          "if(route==='profile-view')initProfileView();",
          "if(route==='conversation')initConversation();",
          "if(route==='tokens')initTokens();",
          "if(route==='admin')initAdmin();",
          "if(route==='settings')initSettings();",
          "initPwToggles();",
        "}",

        # Enhanced embers (Disney: varied size, color, sway, timing)
        "function initEmbers(){",
          "var e=$('embers');if(!e)return;",
          "var colors=['#ea580c','#f59e0b','#ef4444','#dc2626'];",
          "var classes=['dp-ember--a','dp-ember--b','dp-ember--c'];",
          "for(var i=0;i<30;i++){",
            "var d=document.createElement('div');",
            "var sz=2+Math.random()*7;",
            "var cls=classes[i%3];",
            "var col=colors[Math.floor(Math.random()*colors.length)];",
            "var peak=0.5+Math.random()*0.4;",
            "d.className='dp-ember '+cls;",
            "d.style.left=Math.random()*100+'%';",
            "d.style.width=sz+'px';d.style.height=sz+'px';",
            "d.style.background=col;",
            "d.style.setProperty('--dp-ember-peak',String(peak));",
            "d.style.animationDelay=Math.random()*5+'s';",
            "d.style.animationDuration=(3+Math.random()*5)+'s';",
            "if(sz>5){d.style.boxShadow='0 0 '+Math.round(sz)+'px '+col;d.style.filter='blur(0)';}",
            "else{d.style.filter='blur(0.5px)';}",
            "e.appendChild(d);",
          "}",
        "}",

        # Scroll-triggered reveal (IntersectionObserver)
        "function initScrollReveal(){",
          "if(typeof IntersectionObserver==='undefined')return;",
          "var els=document.querySelectorAll('.dp-scroll-reveal');",
          "if(!els.length)return;",
          "var io=new IntersectionObserver(function(entries){",
            "entries.forEach(function(en){",
              "if(en.isIntersecting){",
                "en.target.classList.add('dp-visible');",
                "io.unobserve(en.target);",
              "}",
            "});",
          "},{threshold:0.12});",
          "els.forEach(function(el,i){",
            "el.style.transitionDelay=(i*44)+'ms';",
            "io.observe(el);",
          "});",
        "}",

        # Landing page hero stat counters
        "function initLandingCounters(){",
          "var box=$('hero-stats');if(!box)return;",
          "box.style.display='none';",
          "var src=box.getAttribute('data-stats-src');if(!src)return;",
          "fetch(src).then(function(r){return r.ok?r.json():null;}).then(function(d){",
            "if(!d)return;",
            "var els=box.querySelectorAll('[data-stat-key]');",
            "var hasAny=false;",
            "els.forEach(function(el){",
              "var key=el.getAttribute('data-stat-key');",
              "var target=d[key]||0;",
              "if(target>0)hasAny=true;",
              "animateCounter(el,target);",
            "});",
            "if(hasAny)box.style.display='';",
          "}).catch(function(){});",
        "}",
        "function animateCounter(el,target){",
          "if(!target||target<=0){el.textContent='0';return;}",
          "var duration=800;var start=performance.now();",
          "function step(now){",
            "var t=Math.min((now-start)/duration,1);",
            "var ease=1-Math.pow(1-t,3);",
            "var val=Math.round(ease*target);",
            "el.textContent=val>=1000?(val/1000).toFixed(1)+'K':String(val);",
            "if(t<1)requestAnimationFrame(step);",
          "}",
          "requestAnimationFrame(step);",
        "}",

        # Auth  login with inline validation + forgot pw
        "function initLogin(){var f=$('login-form');if(!f)return;var submit=f.querySelector('[type=submit]');var emailIn=$('login-email'),pwIn=$('login-password');if(emailIn)emailIn.addEventListener('blur',function(){validateEmail(emailIn,'err-login-email');});if(pwIn)pwIn.addEventListener('blur',function(){var e=$('err-login-password');if(e)e.textContent=pwIn.value.length?'':'Password is required';});var fpLink=$('forgot-pw-link');if(fpLink)fpLink.onclick=function(ev){ev.preventDefault();openForgotPwModal();};f.onsubmit=async function(e){e.preventDefault();var d=new FormData(f);if(d.get('_hp'))return;hideErr();if(!validateEmail(emailIn,'err-login-email'))return;if(!d.get('password')){setFieldErr('err-login-password','Password is required');return;}setButtonBusy(submit,true,'Signing in...');try{var r=await fetch('/api/auth/sign-in/email',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({email:d.get('email'),password:d.get('password')})});if(r.ok){var j=await r.json();AUTH=j.user||j;window.__AUTH__=AUTH;location.href='/app'}else{var j={};try{j=await r.json();}catch(_e){}showErr(mapAuthError(j.message||'Login failed'));}}catch(x){showErr('Connection failed. Check your internet and try again.')}setButtonBusy(submit,false);};}",

        # Auth  signup with terms, age, pw strength, location prompt
        "function initSignup(){var f=$('signup-form');if(!f)return;var submit=$('signup-submit');var nameIn=$('signup-name'),emailIn=$('signup-email'),pwIn=$('signup-password');var termsCheck=$('terms-check'),ageCheck=$('age-check');var pwStrength=$('pw-strength');function checkSubmitReady(){var ready=!!(termsCheck&&termsCheck.checked&&ageCheck&&ageCheck.checked);if(submit)submit.disabled=!ready;}if(termsCheck)termsCheck.addEventListener('change',checkSubmitReady);if(ageCheck)ageCheck.addEventListener('change',checkSubmitReady);checkSubmitReady();if(nameIn)nameIn.addEventListener('blur',function(){var e=$('err-signup-name');if(e)e.textContent=(nameIn.value.trim().length>=2)?'':'Display name must be at least 2 characters';});if(emailIn)emailIn.addEventListener('blur',function(){validateEmail(emailIn,'err-signup-email');});if(pwIn){pwIn.addEventListener('input',function(){updatePwStrength(pwIn.value,pwStrength);});pwIn.addEventListener('blur',function(){var e=$('err-signup-password');if(e)e.textContent=(pwIn.value.length>=8)?'':'Password must be at least 8 characters';});}f.onsubmit=async function(e){e.preventDefault();var d=new FormData(f);if(d.get('_hp'))return;hideErr();var valid=true;if(nameIn&&nameIn.value.trim().length<2){setFieldErr('err-signup-name','Display name must be at least 2 characters');valid=false;}if(!validateEmail(emailIn,'err-signup-email'))valid=false;if(pwIn&&pwIn.value.length<8){setFieldErr('err-signup-password','Password must be at least 8 characters');valid=false;}if(!valid)return;if(!termsCheck||!termsCheck.checked||!ageCheck||!ageCheck.checked){showErr('Please accept the terms and confirm your age');return;}setButtonBusy(submit,true,'Creating account...');try{var r=await fetch('/api/auth/sign-up/email',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({name:d.get('name'),email:d.get('email'),password:d.get('password')})});if(r.ok){var j=await r.json();AUTH=j.user||j;window.__AUTH__=AUTH;showLocationPrompt();}else{var j={};try{j=await r.json();}catch(_e){}showErr(mapAuthError(j.message||'Signup failed'));}}catch(x){showErr('Connection failed. Check your internet and try again.')}setButtonBusy(submit,false);};}",

        # Auth helpers
        "function showErr(m){var el=$('auth-error');if(el){el.textContent=m;el.style.display='block';replayAnimation(el,'dp-error-shake');}}",
        "function hideErr(){var el=$('auth-error');if(el){el.style.display='none';el.textContent='';}}",
        "function setFieldErr(id,msg){var el=$(id);if(el){el.textContent=msg||'';if(msg){var field=el.closest('.dp-field');if(field){var input=field.querySelector('.dp-input');if(input)replayAnimation(input,'dp-shake');}}}}",
        "function validateEmail(inp,errId){if(!inp)return false;var v=inp.value.trim();var ok=/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(v);setFieldErr(errId,ok?'':'Please enter a valid email address');return ok;}",
        "function mapAuthError(msg){var m=String(msg||'').toLowerCase();if(m.indexOf('invalid')!==-1||m.indexOf('credentials')!==-1)return'Email or password is incorrect';if(m.indexOf('not found')!==-1||m.indexOf('no user')!==-1)return'No account found with that email';if(m.indexOf('already')!==-1||m.indexOf('exists')!==-1)return'An account with that email already exists';if(m.indexOf('too many')!==-1||m.indexOf('rate')!==-1)return'Too many attempts. Please try again in a few minutes.';return msg;}",
        "function updatePwStrength(pw,el){if(!el)return;var len=pw.length;if(!len){el.removeAttribute('data-level');return;}if(len<8){el.setAttribute('data-level','weak');return;}var hasUpper=/[A-Z]/.test(pw),hasLower=/[a-z]/.test(pw),hasNum=/[0-9]/.test(pw),hasSym=/[^a-zA-Z0-9]/.test(pw);var variety=(hasUpper?1:0)+(hasLower?1:0)+(hasNum?1:0)+(hasSym?1:0);el.setAttribute('data-level',variety>=3?'strong':'fair');}",
        "function initPwToggles(){document.querySelectorAll('[data-toggle-pw]').forEach(function(btn){btn.onclick=function(){var id=btn.getAttribute('data-toggle-pw');var inp=$(id);if(!inp)return;var show=inp.type==='password';inp.type=show?'text':'password';btn.classList.toggle('dp-pw-visible',show);};});}",

        # Forgot password stub
        "function openForgotPwModal(){var m=openModal({title:'Reset password',bodyHtml:'<p>Enter your email and we will send a reset link.</p><input type=\"email\" id=\"fp-email\" class=\"dp-input\" placeholder=\"you@example.com\"/>'});var sendBtn=m.addButton({label:'Send reset link',cls:'dp-btn-fire'});m.addButton({label:'Cancel',cls:'dp-btn-ghost',onClick:m.close});sendBtn.onclick=function(){var email=m.body.querySelector('#fp-email');if(!email||!email.value.trim()){toast('Enter your email','error');return;}setButtonBusy(sendBtn,true,'Sending...');setTimeout(function(){m.close();toast('If an account exists with that email, you will receive a reset link.','success');},1200);};}",

        # Post-signup location prompt
        "function showLocationPrompt(){var m=openModal({title:'Enable your location',bodyHtml:'<div class=\"dp-loc-prompt\"><svg class=\"dp-loc-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" width=\"48\" height=\"48\"><path d=\"M12 2a7 7 0 017 7c0 5.25-7 13-7 13S5 14.25 5 9a7 7 0 017-7z\"/><circle cx=\"12\" cy=\"9\" r=\"2.5\"/></svg><h2>See who is nearby</h2><p>Dark Phoenix uses your location to show people on the live map. This is how connections happen.</p><ul class=\"dp-loc-benefits\"><li>See who is near you in realtime</li><li>Your location auto-expires every 5 minutes</li><li>You can pause sharing anytime</li></ul></div>'});var enableBtn=m.addButton({label:'Enable location',cls:'dp-btn-fire'});var skipBtn=m.addButton({label:'Maybe later',cls:'dp-btn-ghost'});skipBtn.onclick=function(){m.close();location.href='/app';};enableBtn.onclick=function(){setButtonBusy(enableBtn,true,'Requesting...');if(!navigator.geolocation){m.body.innerHTML='<div class=\"dp-loc-prompt\"><p>Your browser does not support geolocation.</p></div>';setTimeout(function(){m.close();location.href='/app';},2000);return;}navigator.geolocation.getCurrentPosition(function(pos){window.__SHOW_LOCATION_PROMPT__=true;m.body.innerHTML='<div class=\"dp-loc-prompt dp-loc-success\"><svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"48\" height=\"48\"><path class=\"dp-check-anim\" d=\"M5 13l4 4L19 7\"/></svg><h2>You are all set!</h2><p>Redirecting to the map...</p></div>';fetch('/api/location',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({lat:pos.coords.latitude,lng:pos.coords.longitude,ts:new Date().toISOString()})});setTimeout(function(){m.close();location.href='/app';},1500);},function(){m.body.innerHTML='<div class=\"dp-loc-prompt\"><p>No worries. You can enable location later from the map or Settings.</p></div>';m.actions.innerHTML='';var cont=m.addButton({label:'Continue to app',cls:'dp-btn-fire'});cont.onclick=function(){m.close();location.href='/app';};},{enableHighAccuracy:true,timeout:10000});};}",

        # Age gate for landing links
        "function initAgeGateLinks(){document.querySelectorAll('[data-age-gate]').forEach(function(link){link.addEventListener('click',function(ev){if(sessionStorage.getItem('dp_age_verified'))return;ev.preventDefault();ev.stopPropagation();openAgeGate(link.getAttribute('href')||'/signup');});});}",
        "function openAgeGate(targetPath){var m=openModal({title:'Age Verification',bodyHtml:'<p style=\"color:#9ca3af;line-height:1.6;margin-bottom:1rem\">Dark Phoenix is an adults-only platform. You must be 18 or older to create an account.</p><label class=\"dp-check\"><input type=\"checkbox\" id=\"age-gate-check\"/><span class=\"dp-check-box\"></span><span>I confirm I am 18 years of age or older</span></label><p style=\"color:#6b7280;font-size:0.75rem;margin-top:1rem;line-height:1.5\">By proceeding you confirm you meet the minimum age requirement. Misrepresentation of age violates our Terms of Service.</p>'});m.addButton({label:'Cancel',cls:'dp-btn-ghost',onClick:function(){m.close();}});var cont=m.addButton({label:'Continue to signup',cls:'dp-btn-fire'});cont.disabled=true;var cb=m.body.querySelector('#age-gate-check');if(cb)cb.addEventListener('change',function(){cont.disabled=!cb.checked;});cont.onclick=function(){if(!cb||!cb.checked)return;sessionStorage.setItem('dp_age_verified','1');m.close();navigate(targetPath);};}",

        "function fieldFilled(v){return !!(v&&String(v).trim().length);}",

        "function modalEscape(v){return String(v||'').replace(/[&<>\\\"]/g,function(c){return c==='&'?'&amp;':c==='<'?'&lt;':c==='>'?'&gt;':'&quot;'})}",

        "function openModal(opts){",
          "var old=document.querySelector('.dp-modal-backdrop');if(old)old.remove();",
          "var backdrop=document.createElement('div');backdrop.className='dp-modal-backdrop';",
          "var safeTitle=modalEscape(opts.title||'');",
          "var bodyHtml=opts.bodyHtml||'';",
          "backdrop.innerHTML='<div class=\"dp-modal\" role=\"dialog\" aria-modal=\"true\" tabindex=\"-1\" aria-label=\"'+safeTitle+'\"><div class=\"dp-modal-head\"><h3>'+safeTitle+'</h3><button type=\"button\" class=\"dp-modal-close\" aria-label=\"Close\"></button></div><div class=\"dp-modal-body\">'+bodyHtml+'</div><div class=\"dp-modal-actions\"></div></div>';",
          "document.body.appendChild(backdrop);",
          "var modal=backdrop.querySelector('.dp-modal');",
          "var actions=backdrop.querySelector('.dp-modal-actions');",
          "var closing=false;",
          "var escListener=function(e){if(e.key==='Escape')close();};",
          "function close(){",
            "if(closing)return;",
            "closing=true;",
            "document.removeEventListener('keydown',escListener);",
            "if(modal)modal.classList.add('dp-closing');",
            "backdrop.classList.add('dp-closing');",
            "setTimeout(function(){if(backdrop&&backdrop.parentElement)backdrop.parentElement.removeChild(backdrop);},190);",
          "}",
          "function addButton(def){",
            "var btn=document.createElement('button');",
            "btn.type='button';",
            "btn.className='dp-btn '+(def.cls||'dp-btn-ghost');",
            "btn.textContent=def.label||'Action';",
            "btn.onclick=def.onClick||function(){};",
            "actions.appendChild(btn);",
            "return btn;",
          "}",
          "backdrop.addEventListener('click',function(e){if(e.target===backdrop)close();});",
          "backdrop.querySelector('.dp-modal-close').onclick=close;",
          "document.addEventListener('keydown',escListener);",
          "if(modal)modal.focus&&modal.focus();",
          "applyStagger(modal);",
          "return {root:backdrop,modal:modal,body:backdrop.querySelector('.dp-modal-body'),actions:actions,close:close,addButton:addButton};",
        "}",

        "function updateProfileCompletion(form){",
          "var keys=['display_name','bio','avatar_url','age','position','body_type','looking_for','tribe'];",
          "var filled=0;",
          "keys.forEach(function(name){",
            "var el=form.querySelector('[name=\"'+name+'\"]');",
            "if(el&&fieldFilled(el.value))filled++;",
          "});",
          "var pct=Math.round((filled/keys.length)*100);",
          "var bar=$('profile-progress'),label=$('profile-progress-label');",
          "if(label&&label.textContent!==pct+'%')replayAnimation(label,'dp-count-bump');",
          "if(bar)bar.style.width=pct+'%';",
          "if(label)label.textContent=pct+'%';",
        "}",


        "function setSheetOpen(sheet,head,isOpen){",
          "if(!sheet)return;",
          "var open=!!isOpen;",
          "sheet.classList.toggle('open',open);",
          "if(head)head.setAttribute('aria-expanded',open?'true':'false');",
          "var page=sheet.closest('.dp-map-page');",
          "if(page)page.classList.toggle('dp-sheet-open',open);",
        "}",

        # Chat helpers: date grouping, bubble rendering, lightbox
        "function formatMsgDate(dateStr){",
          "if(!dateStr)return'';",
          "var d=new Date(dateStr+'Z');if(isNaN(d))return'';",
          "var now=new Date();var today=new Date(now.getFullYear(),now.getMonth(),now.getDate());",
          "var msgDay=new Date(d.getFullYear(),d.getMonth(),d.getDate());",
          "var diff=Math.floor((today-msgDay)/86400000);",
          "if(diff===0)return'Today';",
          "if(diff===1)return'Yesterday';",
          "var days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];",
          "var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];",
          "return days[d.getDay()]+', '+months[d.getMonth()]+' '+d.getDate();",
        "}",

        "function formatMsgTime(dateStr){",
          "if(!dateStr)return'';",
          "var d=new Date(dateStr+'Z');if(isNaN(d))return dateStr;",
          "var h=d.getHours();var m=d.getMinutes();",
          "return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');",
        "}",

        "function renderBubbleHtml(m,isNew){",
          "var mine=AUTH&&m.from_id===AUTH.userId;",
          "var cls=mine?'dp-bubble dp-bubble-mine':'dp-bubble dp-bubble-theirs';",
          "if(isNew)cls+=' dp-bubble-new';",
          "var id=String(m.id||'');",
          "var mediaUrl=m.media_url||'';",
          "var msgType=m.message_type||'text';",
          "var readVal=m.read||0;",
          "var mediaEl='';",
          "if(msgType==='image'&&mediaUrl){",
            "mediaEl='<div class=\"dp-media-preview\"><img src=\"'+esc(mediaUrl)+'\" alt=\"shared image\" loading=\"lazy\" class=\"dp-chat-image\" data-lightbox/></div>';",
          "}",
          "var receiptEl='';",
          "if(mine){",
            "if(readVal===1){",
              "receiptEl='<span class=\"dp-receipt dp-receipt-read\" title=\"Read\"><svg viewBox=\"0 0 16 11\" width=\"16\" height=\"11\"><path d=\"M1 5.5l3.5 3.5L11 2\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/><path d=\"M5.5 5.5L9 9 15.5 2\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg></span>';",
            "}else{",
              "receiptEl='<span class=\"dp-receipt dp-receipt-sent\" title=\"Sent\"><svg viewBox=\"0 0 12 11\" width=\"12\" height=\"11\"><path d=\"M1 5.5l3.5 3.5L11 2\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg></span>';",
            "}",
          "}",
          "var contentEl=(m.content||'')?'<p>'+esc(m.content||'')+'</p>':'';",
          "var time=formatMsgTime(m.created_at||'');",
          "return'<div class=\"'+cls+'\" data-mid=\"'+esc(id)+'\">'+mediaEl+contentEl+'<small>'+esc(time)+receiptEl+'</small></div>';",
        "}",

        "function openLightbox(src){",
          "var old=document.querySelector('.dp-lightbox-backdrop');if(old)old.remove();",
          "var lb=document.createElement('div');lb.className='dp-lightbox-backdrop';",
          "lb.innerHTML='<img src=\"'+esc(src)+'\" alt=\"\"/>';",
          "document.body.appendChild(lb);",
          "lb.onclick=function(){",
            "lb.classList.add('dp-closing');",
            "setTimeout(function(){if(lb.parentElement)lb.remove();},200);",
          "};",
          "document.addEventListener('keydown',function handler(e){",
            "if(e.key==='Escape'){lb.click();document.removeEventListener('keydown',handler);}",
          "});",
        "}",

        "function renderConversationMessages(msgEl,msgs,opts){",
          "if(!msgEl)return;",
          "opts=opts||{};",
          "var sentinel=document.getElementById('scroll-sentinel-top');",
          "var loader=document.getElementById('loading-older');",
          "var typingEl=document.getElementById('typing-indicator');",
          "var empty=document.getElementById('empty-convo');",
          "if(empty)empty.remove();",
          "if(!msgs.length&&!opts.append&&!opts.prepend){",
            "var existing=msgEl.querySelectorAll('.dp-bubble');",
            "if(!existing.length){",
              "var p=document.createElement('p');p.className='dp-muted dp-empty';p.id='empty-convo';p.textContent='Start the conversation!';",
              "if(typingEl)msgEl.insertBefore(p,typingEl);else msgEl.appendChild(p);",
            "}",
            "return;",
          "}",
          "var frag=document.createDocumentFragment();",
          "var lastDate='';",
          "var existingMids=new Set();",
          "msgEl.querySelectorAll('[data-mid]').forEach(function(el){existingMids.add(el.getAttribute('data-mid'));});",
          "msgs.forEach(function(m){",
            "var mid=String(m.id||'');",
            "if(existingMids.has(mid)){",
              # Update read receipts on existing bubbles
              "var el=msgEl.querySelector('[data-mid=\"'+mid+'\"]');",
              "if(el&&m.read===1){",
                "var r=el.querySelector('.dp-receipt-sent');",
                "if(r){r.className='dp-receipt dp-receipt-read';r.title='Read';r.innerHTML='<svg viewBox=\"0 0 16 11\" width=\"16\" height=\"11\"><path d=\"M1 5.5l3.5 3.5L11 2\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/><path d=\"M5.5 5.5L9 9 15.5 2\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>';}",
              "}",
              "return;",
            "}",
            # Date divider
            "var dateLabel=formatMsgDate(m.created_at||'');",
            "if(dateLabel&&dateLabel!==lastDate){",
              "var divider=document.createElement('div');divider.className='dp-msg-date-divider';",
              "divider.innerHTML='<span>'+esc(dateLabel)+'</span>';",
              "frag.appendChild(divider);",
              "lastDate=dateLabel;",
            "}",
            "var wrapper=document.createElement('div');",
            "wrapper.innerHTML=renderBubbleHtml(m,!!opts.append);",
            "var bubble=wrapper.firstChild;",
            "if(opts.prepend)bubble.classList.add('dp-bubble-prepend');",
            "frag.appendChild(bubble);",
          "});",
          "if(opts.prepend){",
            "var scrollH=msgEl.scrollHeight;",
            "var insertRef=sentinel?sentinel.nextSibling:(loader?loader.nextSibling:msgEl.firstChild);",
            "if(loader&&loader.nextSibling)insertRef=loader.nextSibling;",
            "msgEl.insertBefore(frag,insertRef);",
            "msgEl.scrollTop=msgEl.scrollHeight-scrollH+msgEl.scrollTop;",
          "}else{",
            "var insertBefore=typingEl||null;",
            "msgEl.insertBefore(frag,insertBefore);",
            "if(!opts.noScroll)msgEl.scrollTop=msgEl.scrollHeight;",
          "}",
        "}",

        # Map
        "function initMap(){",
          "var el=$('map');if(!el||typeof L==='undefined')return;",
          "mapInst=L.map('map',{zoomControl:true}).setView([37.7749,-122.4194],13);",
          "L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{",
            "attribution:'&copy; OpenStreetMap &copy; CARTO',maxZoom:19",
          "}).addTo(mapInst);",
          "sheetPrimed=false;",
          "if(window.__SHOW_LOCATION_PROMPT__){geoEnabled=true;window.__SHOW_LOCATION_PROMPT__=false;}",

          "setGeoStatus(geoEnabled?'Locating nearby...':'Location paused',geoEnabled?'warn':'off');",
          "var sheet=$('nearby-sheet');",
          "var head=sheet?sheet.querySelector('.dp-nearby-head'):null;",
          "if(head&&sheet){",
            "head.setAttribute('role','button');",
            "head.setAttribute('tabindex','0');",
            "head.setAttribute('aria-expanded',sheet.classList.contains('open')?'true':'false');",
            "head.onclick=function(){",
              "setSheetOpen(sheet,head,!sheet.classList.contains('open'));",
            "};",
            "head.onkeydown=function(e){",
              "if(e.key==='Enter'||e.key===' '){e.preventDefault();head.click();}",
            "};",
          "}",

          "var btn=$('geo-toggle');",
          "if(btn)btn.onclick=function(){",
            "geoEnabled=!geoEnabled;",
            "replayAnimation(btn,'dp-tap-pop');",
            "btn.classList.toggle('active',geoEnabled);",
            "setGeoStatus(geoEnabled?'Locating nearby...':'Location paused',geoEnabled?'warn':'off');",
            "if(!geoEnabled&&geoWatchId){navigator.geolocation.clearWatch(geoWatchId);geoWatchId=null;}",
            "else if(geoEnabled)startGeo();",
          "};",

          "var filterBtn=$('filter-toggle');",
          "if(filterBtn)filterBtn.onclick=function(){openFilterPanel();};",
          "updateFilterBadge();",

          "if(geoEnabled)startGeo();",
          "pollNearby();",
          "pollTimer=setInterval(pollNearby,pollInterval);",
          "setTimeout(function(){toast('Share your location to see who\\'s nearby')},1500);",
        "}",

        "function startGeo(){",
          "if(!navigator.geolocation){setGeoStatus('Geolocation unavailable','warn');return;}",
          "var btn=$('geo-toggle');if(btn)btn.classList.add('active');",
          "geoWatchId=navigator.geolocation.watchPosition(function(pos){",
            "var lat=pos.coords.latitude,lng=pos.coords.longitude;",
            "selfLatLng=[lat,lng];",
            "if(mapInst)mapInst.setView([lat,lng],15);",
            "updateSelfMarker(lat,lng);",
            "setGeoStatus('Location sharing on','live');",
            "fetch('/api/location',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({lat:lat,lng:lng,ts:new Date().toISOString()})});",
          "},function(err){",
            "setGeoStatus('Location unavailable','warn');",
          "},{enableHighAccuracy:true,maximumAge:30000,timeout:10000});",
        "}",

        "function updateSelfMarker(lat,lng){",
          "if(!mapInst)return;",
          "if(!selfMarker){",
            "var html='<div class=\"dp-self-marker\"><div class=\"dp-self-ring-outer\"></div><div class=\"dp-self-ring\"></div><div class=\"dp-self-dot\"></div></div>';",
            "var icon=L.divIcon({className:'',html:html,iconSize:[44,44],iconAnchor:[22,22]});",
            "selfMarker=L.marker([lat,lng],{icon:icon,zIndexOffset:1000,interactive:true}).addTo(mapInst);",
            "selfMarker.on('click',function(){openSelfProfileModal();});",
          "}else{",
            "selfMarker.setLatLng([lat,lng]);",
          "}",
        "}",

        "async function openSelfProfileModal(){",
          "if(!AUTH)return;",
          "var uid=AUTH.userId;",
          "closePinModal();",
          "var backdrop=document.createElement('div');backdrop.className='dp-pin-modal-backdrop';",
          "var modal=document.createElement('div');modal.className='dp-pin-modal';",
          "modal.innerHTML='<div class=\"dp-pin-modal-handle\"></div><div class=\"dp-pin-modal-loading\"><div class=\"dp-spinner\"></div></div>';",
          "document.body.appendChild(backdrop);document.body.appendChild(modal);",
          "backdrop.onclick=function(){closePinModal();};",
          "_pinModalEsc=function(e){if(e.key==='Escape')closePinModal();};",
          "document.addEventListener('keydown',_pinModalEsc);",
          "try{",
            "var r=await fetch('/api/profile/'+uid);",
            "if(!r.ok){closePinModal();toast('Could not load profile','error');return;}",
            "var p=await r.json();",
            "var name=p.display_name||AUTH.name||'You';",
            "var av=p.avatar_url||'';",
            "var avHtml=av?'<img src=\"'+esc(av)+'\" class=\"dp-pin-modal-avatar\" alt=\"\"/>':'<div class=\"dp-pin-modal-avatar-letter\">'+esc(name.charAt(0).toUpperCase())+'</div>';",
            "var tags=[];",
            "if(p.age)tags.push(String(p.age));",
            "if(p.position)tags.push(pinTagLabel(p.position));",
            "if(p.body_type)tags.push(pinTagLabel(p.body_type));",
            "if(p.tribe)tags.push(pinTagLabel(p.tribe));",
            "var tagHtml='';tags.forEach(function(t){tagHtml+='<span class=\"dp-pin-modal-tag\">'+esc(t)+'</span>';});",
            "modal.innerHTML='<div class=\"dp-pin-modal-handle\"></div><div class=\"dp-pin-modal-body\">'+avHtml+'<h3>'+esc(name)+'</h3>'+(p.bio?'<p class=\"dp-bio\">'+esc(p.bio)+'</p>':'')+(tagHtml?'<div class=\"dp-pin-modal-tags\">'+tagHtml+'</div>':'')+'<div class=\"dp-pin-modal-actions\"><a href=\"/profile\" class=\"dp-btn dp-btn-fire\" data-nav>Edit profile</a></div></div>';",
            "applyStagger(modal);",
          "}catch(_e){closePinModal();toast('Network error','error');}",
        "}",

        "function pinTagLabel(v){",
          "var map={top:'Top',bottom:'Bottom',vers:'Vers',side:'Side',slim:'Slim',athletic:'Athletic',average:'Average',muscular:'Muscular',stocky:'Stocky',bear:'Bear',twink:'Twink',jock:'Jock',otter:'Otter',daddy:'Daddy',wolf:'Wolf',cub:'Cub',geek:'Geek',rugged:'Rugged',not_saying:'Not saying'};",
          "return map[v]||v||'';",
        "}",

        "async function openUserPinModal(userId){",
          "if(!AUTH)return;",
          "closePinModal();",
          "var backdrop=document.createElement('div');backdrop.className='dp-pin-modal-backdrop';",
          "var modal=document.createElement('div');modal.className='dp-pin-modal';",
          "modal.innerHTML='<div class=\"dp-pin-modal-handle\"></div><div class=\"dp-pin-modal-loading\"><div class=\"dp-spinner\"></div></div>';",
          "document.body.appendChild(backdrop);document.body.appendChild(modal);",
          "backdrop.onclick=function(){closePinModal();};",
          "_pinModalEsc=function(e){if(e.key==='Escape')closePinModal();};",
          "document.addEventListener('keydown',_pinModalEsc);",
          "try{",
            "var r=await fetch('/api/profile/'+userId);",
            "if(!r.ok){closePinModal();toast('Could not load profile','error');return;}",
            "var p=await r.json();",
            "var name=p.display_name||'Anonymous';",
            "var av=p.avatar_url||'';",
            "var avHtml=av?'<img src=\"'+esc(av)+'\" class=\"dp-pin-modal-avatar\" alt=\"\"/>':'<div class=\"dp-pin-modal-avatar-letter\">'+esc(name.charAt(0).toUpperCase())+'</div>';",
            "var bio=p.bio||'';",
            "var tags=[];",
            "if(p.age)tags.push(String(p.age));",
            "if(p.position)tags.push(pinTagLabel(p.position));",
            "if(p.body_type)tags.push(pinTagLabel(p.body_type));",
            "if(p.tribe)tags.push(pinTagLabel(p.tribe));",
            "if(p.looking_for)tags.push(p.looking_for);",
            "var tagHtml='';tags.forEach(function(t){tagHtml+='<span class=\"dp-pin-modal-tag\">'+esc(t)+'</span>';});",
            "modal.innerHTML='<div class=\"dp-pin-modal-handle\"></div><div class=\"dp-pin-modal-body\">'+avHtml+'<h3>'+esc(name)+'</h3>'+(bio?'<p class=\"dp-bio\">'+esc(bio)+'</p>':'')+(tagHtml?'<div class=\"dp-pin-modal-tags\">'+tagHtml+'</div>':'')+'<div class=\"dp-pin-modal-actions\"><a href=\"/messages/'+esc(userId)+'\" class=\"dp-btn dp-btn-fire\" data-nav onclick=\"closePinModal()\">Message</a><a href=\"/profile/'+esc(userId)+'\" class=\"dp-btn dp-btn-ghost\" data-nav onclick=\"closePinModal()\">View profile</a></div></div>';",
            "applyStagger(modal);",
          "}catch(_e){closePinModal();toast('Network error','error');}",
        "}",

        "var _pinModalEsc=null;",
        "window.closePinModal=function(){",
          "var backdrop=document.querySelector('.dp-pin-modal-backdrop');",
          "var modal=document.querySelector('.dp-pin-modal');",
          "if(_pinModalEsc){document.removeEventListener('keydown',_pinModalEsc);_pinModalEsc=null;}",
          "if(modal)modal.classList.add('dp-closing');",
          "if(backdrop)backdrop.classList.add('dp-closing');",
          "setTimeout(function(){if(backdrop&&backdrop.parentElement)backdrop.remove();if(modal&&modal.parentElement)modal.remove();},220);",
        "};",
        "var closePinModal=window.closePinModal;",

        "async function pollNearby(){",
          "try{",
            "var url='/api/nearby';",
            "var f=getFilters();",
            "var params=[];",
            "if(f.max_distance)params.push('max_distance='+f.max_distance);",
            "if(f.min_age)params.push('min_age='+f.min_age);",
            "if(f.max_age)params.push('max_age='+f.max_age);",
            "if(f.body_type&&f.body_type.length)params.push('body_type='+encodeURIComponent(f.body_type.join(',')));",
            "if(f.position&&f.position.length)params.push('position='+encodeURIComponent(f.position.join(',')));",
            "if(f.tribe&&f.tribe.length)params.push('tribe='+encodeURIComponent(f.tribe.join(',')));",
            "if(params.length)url+='?'+params.join('&');",
            "var r=await fetch(url);if(!r.ok)return;",
            "var d=await r.json();var users=d.users||[];var seen={};",
            "users.forEach(function(u){",
              "var id=u.user_id;seen[id]=true;",
              "var name=esc(u.display_name||'Anonymous');",
              "var av=u.avatar_url||'';",
              "var pin=av?'<div class=\"dp-avatar-pin dp-pin-pop\"><img src=\"'+esc(av)+'\"/></div>':'<div class=\"dp-avatar-pin-letter dp-pin-pop\">'+esc(name.charAt(0).toUpperCase())+'</div>';",
              "if(markers[id]){markers[id].setLatLng([u.lat,u.lng])}",
              "else{",
                "var icon=L.divIcon({className:'',html:pin,iconSize:[36,36],iconAnchor:[18,18]});",
                "markers[id]=L.marker([u.lat,u.lng],{icon:icon}).addTo(mapInst);",
                "(function(uid){markers[uid].on('click',function(){openUserPinModal(uid);});})(id);",
              "}",
            "});",
            "Object.keys(markers).forEach(function(id){if(!seen[id]){mapInst.removeLayer(markers[id]);delete markers[id]}});",
            "renderNearbyList(users);",
            # Adaptive polling: slow down when few users
            "pollInterval=users.length>5?5000:users.length>0?8000:15000;",
          "}catch(e){}",
        "}",

        "function renderNearbyList(users){",
          "var list=$('nearby-list'),count=$('nearby-count'),sheet=$('nearby-sheet');if(!list)return;",
          "var nextCount=String(users.length);",
          "if(count){if(count.textContent!==nextCount)replayAnimation(count,'dp-count-bump');count.textContent=nextCount;}",
          "if(!users.length){",
            "list.innerHTML='<p class=\"dp-muted\">No one nearby yet. Keep sharing location and check back in a moment.</p>';",
            "if(sheet){sheet.classList.remove('dp-sheet-anticipate');setSheetOpen(sheet,sheet.querySelector('.dp-nearby-head'),false);}",
            "sheetPrimed=false;",
            "return;",
          "}",
          "var html='';var hash='';users.forEach(function(u){var name=esc(u.display_name||'Anonymous');var uid=esc(u.user_id||'');hash+=uid+'|'+name+';';html+='<div class=\"dp-nearby-item\"><strong>'+name+'</strong><span><a href=\"/profile/'+uid+'\" data-nav>Profile</a>  <a href=\"/messages/'+uid+'\" data-nav>Message</a></span></div>';});",
          "if(list.getAttribute('data-nearby-hash')!==hash){",
            "list.innerHTML=html;",
            "list.setAttribute('data-nearby-hash',hash);",
            "applyStagger(list);",
          "}",
          "if(sheet){",
            "var head=sheet.querySelector('.dp-nearby-head');",
            "if(!sheet.classList.contains('open')&&!sheetPrimed){",
              "sheet.classList.add('dp-sheet-anticipate');",
              "setTimeout(function(){",
                "if(!sheet||!sheet.parentElement)return;",
                "sheet.classList.remove('dp-sheet-anticipate');",
                "setSheetOpen(sheet,head,true);",
              "},130);",
              "sheetPrimed=true;",
            "}else{",
              "setSheetOpen(sheet,head,true);",
            "}",
          "}",
        "}",

        # Profile
        "function initProfile(){",
          "var f=$('profile-form');if(!f)return;",
          "var saveBtn=f.querySelector('[type=submit]');",
          "f.addEventListener('input',function(){updateProfileCompletion(f)});",
          "f.addEventListener('change',function(){updateProfileCompletion(f)});",
          "updateProfileCompletion(f);",
          "f.onsubmit=async function(e){",
            "e.preventDefault();var d=new FormData(f);",
            "var body={display_name:d.get('display_name'),bio:d.get('bio'),avatar_url:d.get('avatar_url'),looking_for:d.get('looking_for'),body_type:d.get('body_type'),position:d.get('position'),tribe:d.get('tribe')};",
            "var age=d.get('age');if(age)body.age=parseInt(age,10);",
            "if(saveBtn)saveBtn.disabled=true;",
            "var r=await fetch('/api/profile',{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify(body)});",
            "if(r.ok){",
              "var el=$('profile-msg');if(el){el.style.display='block';setTimeout(function(){el.style.display='none'},2000)}",
              "toast('Profile saved','success');",
              "updateProfileCompletion(f);",
            "}else{toast('Failed to save profile','error');}",
            "if(saveBtn)saveBtn.disabled=false;",
          "};",
        "}",

        # Profile view (block/report actions)
        "function initProfileView(){",
          "function setBusy(btn,on,label){",
            "if(!btn)return;",
            "if(on){",
              "btn.disabled=true;",
              "btn.setAttribute('data-label',btn.textContent||'');",
              "if(label)btn.textContent=label;",
            "}else{",
              "btn.disabled=false;",
              "var prev=btn.getAttribute('data-label');",
              "if(prev)btn.textContent=prev;",
            "}",
          "}",

          "function openBlockModal(uid,name,targetBtn){",
            "var m=openModal({",
              "title:'Block user',",
              "bodyHtml:'<p>Block <strong>'+modalEscape(name)+'</strong>? You both stop seeing each other on the map and in messages.</p>'",
            "});",
            "m.addButton({label:'Cancel',cls:'dp-btn-ghost',onClick:m.close});",
            "var confirmBtn=m.addButton({label:'Block user',cls:'dp-btn-ghost dp-btn-danger'});",
            "confirmBtn.onclick=async function(){",
              "setBusy(confirmBtn,true,'Blocking...');",
              "try{",
                "var r=await fetch('/api/block',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({user_id:uid})});",
                "if(r.ok){",
                  "toast('User blocked','success');",
                  "if(targetBtn){targetBtn.textContent='Blocked';targetBtn.disabled=true;}",
                  "m.close();",
                "}else{",
                  "toast('Could not block user','error');",
                  "setBusy(confirmBtn,false);",
                "}",
              "}catch(_e){",
                "toast('Network error','error');",
                "setBusy(confirmBtn,false);",
              "}",
            "};",
          "}",

          "function openReportModal(uid,name){",
            "var reasons=[",
              "{key:'spam',label:'Spam or scam'},",
              "{key:'harassment',label:'Harassment or abusive behavior'},",
              "{key:'fake_profile',label:'Impersonation or fake profile'},",
              "{key:'underage',label:'Suspected underage user'},",
              "{key:'nonconsensual',label:'Non-consensual or unsafe behavior'},",
              "{key:'other',label:'Other'}",
            "];",
            "var reasonHtml='';",
            "reasons.forEach(function(r){",
              "reasonHtml+='<label class=\"dp-reason\"><input type=\"radio\" name=\"report_reason\" value=\"'+r.key+'\"/><span>'+modalEscape(r.label)+'</span></label>';",
            "});",
            "var body='<p>Report <strong>'+modalEscape(name)+'</strong>. Reports are reviewed by moderators.</p><div class=\"dp-report-reasons\">'+reasonHtml+'</div><label class=\"dp-label\" for=\"report-details\">Details (optional)</label><textarea id=\"report-details\" class=\"dp-input\" rows=\"3\" maxlength=\"500\" placeholder=\"Add context that helps review\"></textarea>';",
            "var m=openModal({title:'Report user',bodyHtml:body});",
            "m.addButton({label:'Cancel',cls:'dp-btn-ghost',onClick:m.close});",
            "var submit=m.addButton({label:'Submit report',cls:'dp-btn-fire'});",
            "var selected='';",
            "m.body.querySelectorAll('input[name=report_reason]').forEach(function(i){",
              "i.addEventListener('change',function(){selected=i.value;submit.disabled=!selected;});",
            "});",
            "submit.disabled=true;",
            "submit.onclick=async function(){",
              "if(!selected)return;",
              "setBusy(submit,true,'Submitting...');",
              "var detailsEl=m.body.querySelector('#report-details');",
              "var details=detailsEl?detailsEl.value:'';",
              "try{",
                "var r=await fetch('/api/report',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({reported_user_id:uid,reason:selected,details:details})});",
                "if(r.ok){",
                  "toast('Report submitted','success');",
                  "m.close();",
                "}else if(r.status===429){",
                  "toast('Report limit reached. Try later.','error');",
                  "setBusy(submit,false);",
                "}else{",
                  "toast('Report failed','error');",
                  "setBusy(submit,false);",
                "}",
              "}catch(_e){",
                "toast('Network error','error');",
                "setBusy(submit,false);",
              "}",
            "};",
          "}",

          "document.querySelectorAll('[data-action]').forEach(function(btn){",
            "btn.onclick=function(){",
              "var action=btn.getAttribute('data-action');",
              "var uid=btn.getAttribute('data-uid');",
              "var h=document.querySelector('.dp-profile-card h1');",
              "var name=h?(h.textContent||'this user'):'this user';",
              "if(action==='block'){openBlockModal(uid,name,btn);return;}",
              "if(action==='report'){openReportModal(uid,name);return;}",
            "};",
          "});",
        "}",

        # Conversation  virtual scroll, media, typing, receipts
        "function initConversation(){",
          "var f=$('msg-form');if(!f)return;",
          "var otherId=f.getAttribute('data-other');",
          "var msgEl=$('messages');",
          "var meta=$('msg-meta');",
          "var input=f.querySelector('[name=content]');",
          "var sendBtn=$('msg-send');",
          "var mediaBtn=$('media-btn');",
          "var mediaInput=$('media-input');",
          "var mediaStrip=$('media-preview-strip');",
          "var mediaPreviewImg=$('media-preview-img');",
          "var mediaRemoveBtn=$('media-preview-remove');",
          "var typingEl=$('typing-indicator');",
          "var sentinel=$('scroll-sentinel-top');",
          "var loaderEl=$('loading-older');",
          "var sending=false;",
          "var pendingNode=null;",
          "var newestId=null;",
          "var oldestId=null;",
          "var hasOlder=true;",
          "var loadingOlder=false;",
          "var pendingMediaUrl='';",
          "var lastTypingSent=0;",
          "var typingTimeout=null;",

          "function setSending(on){",
            "sending=on;",
            "if(sendBtn)sendBtn.disabled=on;",
            "if(input)input.disabled=on;",
            "f.classList.toggle('dp-send-pending',on);",
          "}",

          # Track message IDs for cursor-based pagination
          "function updateCursors(msgs){",
            "if(!msgs.length)return;",
            "msgs.forEach(function(m){",
              "var mid=Number(m.id);if(!mid)return;",
              "if(newestId===null||mid>newestId)newestId=mid;",
              "if(oldestId===null||mid<oldestId)oldestId=mid;",
            "});",
          "}",

          # Initial load
          "async function loadInitial(){",
            "try{",
              "var r=await fetch('/api/messages/'+otherId);",
              "if(!r.ok)return;",
              "var d=await r.json();",
              "var msgs=d.messages||[];",
              "updateCursors(msgs);",
              "if(msgs.length<50)hasOlder=false;",
              "renderConversationMessages(msgEl,msgs);",
              "if(d.typing)showTyping();else hideTyping();",
              "await fetch('/api/messages/'+otherId+'/read',{method:'POST'});",
              "refreshUnreadBadge();",
            "}catch(e){}",
          "}",

          # Poll for new messages only (efficient delta)
          "async function pollNewer(){",
            "if(sending)return;",
            "try{",
              "var url=newestId?'/api/messages/'+otherId+'/newer?after='+newestId:'/api/messages/'+otherId;",
              "var r=await fetch(url);",
              "if(!r.ok)return;",
              "var d=await r.json();",
              "var msgs=d.messages||[];",
              "if(msgs.length){",
                "updateCursors(msgs);",
                "renderConversationMessages(msgEl,msgs,{append:true});",
              "}else{",
                # Still update read receipts on existing messages
                "var allR=await fetch('/api/messages/'+otherId);",
                "if(allR.ok){var allD=await allR.json();(allD.messages||[]).forEach(function(m){",
                  "if(m.read===1){var el=msgEl.querySelector('[data-mid=\"'+m.id+'\"]');if(el){var rc=el.querySelector('.dp-receipt-sent');if(rc){rc.className='dp-receipt dp-receipt-read';rc.title='Read';rc.innerHTML='<svg viewBox=\"0 0 16 11\" width=\"16\" height=\"11\"><path d=\"M1 5.5l3.5 3.5L11 2\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/><path d=\"M5.5 5.5L9 9 15.5 2\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>';}}}",
                "});}",
              "}",
              "if(d.typing)showTyping();else hideTyping();",
              "await fetch('/api/messages/'+otherId+'/read',{method:'POST'});",
              "refreshUnreadBadge();",
            "}catch(e){}",
          "}",

          # Load older messages (virtual scroll up)
          "async function loadOlder(){",
            "if(!hasOlder||loadingOlder||!oldestId)return;",
            "loadingOlder=true;",
            "if(loaderEl)loaderEl.style.display='flex';",
            "try{",
              "var r=await fetch('/api/messages/'+otherId+'/older?before='+oldestId);",
              "if(!r.ok){loadingOlder=false;return;}",
              "var d=await r.json();",
              "var msgs=d.messages||[];",
              "if(msgs.length<30)hasOlder=false;",
              "if(msgs.length){",
                "updateCursors(msgs);",
                "renderConversationMessages(msgEl,msgs,{prepend:true});",
              "}",
            "}catch(e){}",
            "if(loaderEl)loaderEl.style.display='none';",
            "loadingOlder=false;",
          "}",

          # Intersection Observer for virtual scroll
          "if(sentinel&&typeof IntersectionObserver!=='undefined'){",
            "var io=new IntersectionObserver(function(entries){",
              "if(entries[0].isIntersecting)loadOlder();",
            "},{root:msgEl,threshold:0.1});",
            "io.observe(sentinel);",
          "}",

          # Typing indicator
          "function showTyping(){",
            "if(typingEl){typingEl.style.display='flex';if(msgEl)msgEl.scrollTop=msgEl.scrollHeight;}",
            "clearTimeout(typingTimeout);",
            "typingTimeout=setTimeout(hideTyping,5000);",
          "}",
          "function hideTyping(){if(typingEl)typingEl.style.display='none';}",

          "function sendTypingSignal(){",
            "var now=Date.now();",
            "if(now-lastTypingSent<3000)return;",
            "lastTypingSent=now;",
            "fetch('/api/messages/'+otherId+'/typing',{method:'POST'});",
          "}",

          "if(input)input.addEventListener('input',sendTypingSignal);",

          # Media upload
          "if(mediaBtn&&mediaInput){",
            "mediaBtn.onclick=function(){mediaInput.click();};",
            "mediaInput.onchange=function(){",
              "var file=mediaInput.files&&mediaInput.files[0];",
              "if(!file)return;",
              "if(!file.type.startsWith('image/')){toast('Only images are supported','error');return;}",
              "if(file.size>512000){toast('Image must be under 500KB','error');return;}",
              "var reader=new FileReader();",
              "reader.onload=function(){",
                "pendingMediaUrl=reader.result;",
                "if(mediaPreviewImg)mediaPreviewImg.src=pendingMediaUrl;",
                "if(mediaStrip)mediaStrip.style.display='flex';",
              "};",
              "reader.readAsDataURL(file);",
            "};",
          "}",

          "if(mediaRemoveBtn){",
            "mediaRemoveBtn.onclick=function(){",
              "pendingMediaUrl='';",
              "if(mediaStrip)mediaStrip.style.display='none';",
              "if(mediaInput)mediaInput.value='';",
            "};",
          "}",

          # Lightbox for images
          "if(msgEl)msgEl.addEventListener('click',function(e){",
            "var img=e.target.closest('[data-lightbox]');",
            "if(img&&img.src)openLightbox(img.src);",
          "});",

          # Boot
          "loadInitial();",
          "pollTimer=setInterval(pollNewer,4000);",

          # Send message
          "f.onsubmit=async function(e){",
            "e.preventDefault();if(sending)return;",
            "var d=new FormData(f);",
            "if(d.get('_hp'))return;",
            "var content=(d.get('content')||'').trim();",
            "var hasMedia=!!pendingMediaUrl;",
            "if(!content&&!hasMedia)return;",
            "setSending(true);",

            # Optimistic bubble
            "if(msgEl){",
              "pendingNode=document.createElement('div');",
              "pendingNode.className='dp-bubble dp-bubble-mine dp-bubble-pending';",
              "var pendingHtml='';",
              "if(hasMedia)pendingHtml+='<div class=\"dp-media-preview\"><img src=\"'+esc(pendingMediaUrl)+'\" class=\"dp-chat-image\" alt=\"\"/></div>';",
              "if(content)pendingHtml+='<p>'+esc(content)+'</p>';",
              "pendingHtml+='<small>sending...</small>';",
              "pendingNode.innerHTML=pendingHtml;",
              "var typIns=typingEl||null;",
              "msgEl.insertBefore(pendingNode,typIns);",
              "msgEl.scrollTop=msgEl.scrollHeight;",
            "}",
            "try{",
              "var body={to_id:otherId,content:content||'',_timing:Date.now()-formLoadTime,_entropy:mouseEntropy};",
              "if(hasMedia){body.media_url=pendingMediaUrl;body.message_type='image';}",
              "var r=await fetch('/api/messages',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)});",
              "var j={};try{j=await r.json()}catch(_e){}",
              "if(r.ok){",
                "if(input)input.value='';",
                "pendingMediaUrl='';",
                "if(mediaStrip)mediaStrip.style.display='none';",
                "if(mediaInput)mediaInput.value='';",
                "if(pendingNode){",
                  "pendingNode.classList.remove('dp-bubble-pending');",
                  "pendingNode.classList.add('dp-bubble-confirmed');",
                  "var ts=pendingNode.querySelector('small');",
                  "if(ts)ts.innerHTML=formatMsgTime(new Date().toISOString().replace('Z',''))+'<span class=\"dp-receipt dp-receipt-sent\" title=\"Sent\"><svg viewBox=\"0 0 12 11\" width=\"12\" height=\"11\"><path d=\"M1 5.5l3.5 3.5L11 2\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg></span>';",
                "}",
                "if(meta&&typeof j.tokens_remaining==='number'){meta.textContent='Tokens left: '+j.tokens_remaining;}",
                "pollNewer();",
              "}else{",
                "if(pendingNode&&pendingNode.parentElement)pendingNode.parentElement.removeChild(pendingNode);",
                "if(j.error==='insufficient_tokens'){toast('Not enough tokens','error');if(meta)meta.textContent='You need tokens to send a message.';}",
                "else if(j.error==='blocked'){toast('You cannot message this user','error');}",
                "else toast('Send failed','error');",
              "}",
            "}catch(_err){",
              "if(pendingNode&&pendingNode.parentElement)pendingNode.parentElement.removeChild(pendingNode);",
              "toast('Network error','error');",
            "}",
            "pendingNode=null;",
            "setSending(false);",
            "if(input)input.focus();",
          "};",
        "}",

        # Tokens  tier purchase, countdown, history
        "function initTokens(){",
          "var balEl=$('token-balance');",
          "if(balEl){",
            "var raw=parseInt(balEl.textContent,10)||0;",
            "balEl.textContent='0';",
            "animateCountOvershoot(balEl,raw,600);",
          "}",

          # Tier selection
          "var selectedTier='';",
          "var tierCards=document.querySelectorAll('[data-tier]');",
          "var buyBtn=$('buy-tokens');",
          "tierCards.forEach(function(card){",
            "card.onclick=function(){",
              "tierCards.forEach(function(c){c.classList.remove('dp-tier-selected','dp-tier-just-selected');});",
              "card.classList.add('dp-tier-selected','dp-tier-just-selected');",
              "selectedTier=card.getAttribute('data-tier');",
              "if(buyBtn){buyBtn.disabled=false;buyBtn.textContent='Buy '+card.querySelector('.dp-tier-name').textContent;}",
              "setTimeout(function(){card.classList.remove('dp-tier-just-selected');},350);",
            "};",
          "});",

          # Buy button
          "if(buyBtn){",
            "buyBtn.disabled=true;",
            "buyBtn.onclick=async function(){",
              "if(!selectedTier)return;",
              "var tierName=document.querySelector('[data-tier=\"'+selectedTier+'\"] .dp-tier-name');",
              "var tierTokens=document.querySelector('[data-tier=\"'+selectedTier+'\"] .dp-tier-tokens');",
              "var label=tierName?tierName.textContent:'';",
              "var amount=tierTokens?tierTokens.textContent.replace(/[^0-9]/g,''):'';",
              "var m=openModal({title:'Confirm purchase',bodyHtml:'<p>Buy <strong>'+esc(label)+'</strong> pack ('+esc(amount)+' tokens)?</p><p class=\"dp-muted\" style=\"font-size:0.8rem;\">This is a demo. No real charge.</p>'});",
              "m.addButton({label:'Cancel',cls:'dp-btn-ghost',onClick:m.close});",
              "var confirm=m.addButton({label:'Confirm',cls:'dp-btn-fire'});",
              "confirm.onclick=async function(){",
                "setButtonBusy(confirm,true,'Processing...');",
                "try{",
                  "var r=await fetch('/api/tokens/purchase',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({tier:selectedTier})});",
                  "var j=await r.json();",
                  "if(r.ok){",
                    "m.close();",
                    "toast('Added '+j.added+' tokens!','success');",
                    "if(balEl){replayAnimation(balEl,'dp-count-overshoot');animateCountOvershoot(balEl,j.balance,500);}",
                    "var hero=document.querySelector('.dp-balance-hero');if(hero)replayAnimation(hero,'dp-purchase-success');",
                    "loadTxnHistory();",
                  "}else{toast(j.error||'Purchase failed','error');setButtonBusy(confirm,false);}",
                "}catch(_e){toast('Network error','error');setButtonBusy(confirm,false);}",
              "};",
            "};",
          "}",

          # Daily claim
          "var cd=$('claim-daily');",
          "if(cd)cd.onclick=async function(){",
            "setButtonBusy(cd,true,'Claiming...');",
            "try{",
              "var r=await fetch('/api/tokens/daily',{method:'POST'});",
              "var j=await r.json();",
              "if(r.ok){",
                "toast('Claimed '+j.added+' tokens!','success');",
                "if(balEl){replayAnimation(balEl,'dp-count-overshoot');animateCountOvershoot(balEl,j.balance,500);}",
                "cd.disabled=true;cd.textContent='Claimed';",
                "var cdEl=$('daily-countdown');if(cdEl&&j.daily_reset_at){cdEl.setAttribute('data-reset',j.daily_reset_at);startCountdown();}",
                "loadTxnHistory();",
              "}else if(j.error==='already_claimed'){toast('Already claimed today','error');setButtonBusy(cd,false);}",
              "else{toast('Claim failed','error');setButtonBusy(cd,false);}",
            "}catch(_e){toast('Network error','error');setButtonBusy(cd,false);}",
          "};",

          # Countdown timer
          "countdownIv=null;",
          "function startCountdown(){",
            "var cdEl=$('daily-countdown');if(!cdEl)return;",
            "var resetAt=cdEl.getAttribute('data-reset');if(!resetAt)return;",
            "if(countdownIv)clearInterval(countdownIv);",
            "function tick(){",
              "var now=Date.now();",
              "var target=new Date(resetAt+'Z').getTime();",
              "var diff=Math.max(0,target-now);",
              "if(diff<=0){cdEl.textContent='Available now!';if(cd){cd.disabled=false;cd.textContent='Claim 20 free';}clearInterval(countdownIv);return;}",
              "var h=Math.floor(diff/3600000);var m=Math.floor((diff%3600000)/60000);var s=Math.floor((diff%60000)/1000);",
              "cdEl.textContent='Next claim in '+String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');",
            "}",
            "tick();countdownIv=setInterval(tick,1000);",
          "}",
          "startCountdown();",

          # Transaction history
          "var txnHeader=$('txn-header'),txnBody=$('txn-body');",
          "if(txnHeader&&txnBody){",
            "txnHeader.onclick=function(){",
              "var open=txnBody.classList.toggle('dp-txn-visible');",
              "txnHeader.classList.toggle('dp-txn-open',open);",
              "if(open&&!txnBody.children.length)loadTxnHistory();",
            "};",
          "}",
          "function loadTxnHistory(){",
            "if(!txnBody)return;",
            "fetch('/api/tokens/history').then(function(r){return r.json()}).then(function(j){",
              "var txns=j.transactions||[];",
              "if(!txns.length){txnBody.innerHTML='<div class=\"dp-txn-row\"><span class=\"dp-txn-type\">No transactions yet</span></div>';return;}",
              "var html='';txns.forEach(function(t){",
                "var isPlus=t.amount>0;",
                "var label=t.type==='purchase'?'Purchase ('+t.tier+')':t.type==='daily'?'Daily claim':t.type==='message'?'Message sent':t.type;",
                "var dateStr=t.created_at?new Date(t.created_at+'Z').toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';",
                "html+='<div class=\"dp-txn-row\"><span class=\"dp-txn-type\">'+esc(label)+'</span><span><span class=\"dp-txn-amount '+(isPlus?'dp-txn-plus':'dp-txn-minus')+'\">'+(isPlus?'+':'')+t.amount+'</span><span class=\"dp-txn-date\">'+esc(dateStr)+'</span></span></div>';",
              "});",
              "txnBody.innerHTML=html;",
            "}).catch(function(){});",
          "}",
        "}",

        "function animateCountOvershoot(el,target,duration){",
          "var started=false,startTs=0;",
          "function frame(ts){",
            "if(!started){started=true;startTs=ts;}",
            "var p=Math.min((ts-startTs)/duration,1);",
            "var eased=p<0.7?(p/0.7)*1.08:1.08-(0.08*((p-0.7)/0.3));",
            "el.textContent=String(Math.round(target*Math.min(eased,1.08)));",
            "if(p<1)requestAnimationFrame(frame);",
            "else el.textContent=String(target);",
          "}",
          "requestAnimationFrame(frame);",
        "}",

        # Settings
        "function initSettings(){",
          "var lb=$('logout-btn');",
          "if(lb)lb.onclick=async function(){",
            "setButtonBusy(lb,true,'Signing out...');",
            "try{",
              "var r=await fetch('/api/auth/sign-out',{method:'POST',headers:{'content-type':'application/json'},body:'{}'});",
              "if(!r.ok){toast('Could not sign out','error');setButtonBusy(lb,false);return;}",
              "AUTH=null;window.__AUTH__=null;location.href='/';",
            "}catch(_e){",
              "toast('Network error','error');",
              "setButtonBusy(lb,false);",
            "}",
          "};",
          "var vb=$('view-blocks');",
          "if(vb)vb.onclick=async function(){",
            "var bl=$('blocks-list');if(!bl)return;",
            "if(bl.style.display!=='none'){bl.style.display='none';setButtonBusy(vb,false);return;}",
            "setButtonBusy(vb,true,'Loading...');",
            "bl.innerHTML='<div class=\"dp-loading\"><div class=\"dp-spinner\"></div></div>';",
            "bl.style.display='block';",
            "var r=await fetch('/api/blocks');var j=await r.json();",
            "var blocks=j.blocks||[];",
            "if(!blocks.length){bl.innerHTML='<p class=\"dp-muted\">No blocked users</p>';setButtonBusy(vb,false);return;}",
            "var html='';blocks.forEach(function(b){",
              "html+='<div class=\"dp-msg-item\"><strong>'+esc(b.display_name||b.user_id)+'</strong><button class=\"dp-btn dp-btn-sm dp-btn-ghost\" data-unblock=\"'+esc(b.user_id)+'\">Unblock</button></div>';",
            "});",
            "bl.innerHTML=html;",
            "setButtonBusy(vb,false);",
            "bl.querySelectorAll('[data-unblock]').forEach(function(btn){",
              "btn.onclick=async function(){",
                "setButtonBusy(btn,true,'Unblocking...');",
                "var uid=btn.getAttribute('data-unblock');",
                "var r=await fetch('/api/block',{method:'DELETE',headers:{'content-type':'application/json'},body:JSON.stringify({user_id:uid})});",
                "if(r.ok){btn.parentElement.remove();toast('User unblocked');}",
                "else{setButtonBusy(btn,false);}",
              "};",
            "});",
          "};",
          "var ge=$('geo-enabled');",
          "if(ge)ge.onchange=function(){geoEnabled=ge.checked;};",
        "}",

        # Messages list init (enables data-nav links in message items)
        "function initMessagesList(){",
          "refreshUnreadBadge();",
        "}",

        # Admin init (placeholder for future admin interactivity)
        "function initAdmin(){}",

        # Unread badge polling
        "async function refreshUnreadBadge(){",
          "if(!AUTH)return;",
          "try{",
            "var r=await fetch('/api/notifications/unread');",
            "if(!r.ok)return;",
            "var d=await r.json();",
            "var count=d.unread_messages||0;",
            "document.querySelectorAll('[data-msg-badge]').forEach(function(b){",
              "b.textContent=count>0?count:'';",
              "if(count>lastUnreadCount){",
                "b.classList.add('dp-badge-pulse');",
                "setTimeout(function(){b.classList.remove('dp-badge-pulse')},650);",
              "}",
            "});",
            "lastUnreadCount=count;",
            "if(count>0){document.title='('+count+') Dark Phoenix';}",
            "else{document.title='Dark Phoenix';}",
          "}catch(_e){}",
        "}",

        "function startUnreadPoll(){",
          "if(!AUTH)return;",
          "refreshUnreadBadge();",
          "unreadTimer=setInterval(refreshUnreadBadge,30000);",
        "}",

        # Filter system  state, panel, controls
        "var _filterState=null;",
        "function getFilters(){",
          "if(_filterState)return _filterState;",
          "try{var s=localStorage.getItem('dp_filters');if(s)_filterState=JSON.parse(s);else _filterState={};}catch(_e){_filterState={};}",
          "return _filterState;",
        "}",
        "function setFilters(f){",
          "_filterState=f||{};",
          "try{localStorage.setItem('dp_filters',JSON.stringify(_filterState));}catch(_e){}",
          "updateFilterBadge();",
        "}",
        "function countActiveFilters(){",
          "var f=getFilters();var c=0;",
          "if(f.max_distance)c++;",
          "if(f.min_age||f.max_age)c++;",
          "if(f.body_type&&f.body_type.length)c++;",
          "if(f.position&&f.position.length)c++;",
          "if(f.tribe&&f.tribe.length)c++;",
          "return c;",
        "}",
        "function updateFilterBadge(){",
          "var badge=$('filter-count');if(!badge)return;",
          "var c=countActiveFilters();",
          "badge.textContent=c>0?c:'';",
          "badge.style.display=c>0?'flex':'none';",
        "}",

        "function openFilterPanel(){",
          "var existing=document.querySelector('.dp-filter-panel');if(existing)return;",
          "var f=getFilters();",
          "var backdrop=document.createElement('div');backdrop.className='dp-filter-backdrop';",
          "var panel=document.createElement('div');panel.className='dp-filter-panel dp-filter-entering';",

          # Build panel HTML
          "var distOpts=[{v:'',l:'Any'},{v:'1',l:'1 km'},{v:'5',l:'5 km'},{v:'10',l:'10 km'},{v:'25',l:'25 km'}];",
          "var distHtml='<div class=\"dp-segment-group\">';",
          "distOpts.forEach(function(o){distHtml+='<button type=\"button\" class=\"dp-segment'+(String(f.max_distance||'')===o.v?' dp-seg-active':'')+'\" data-dist=\"'+o.v+'\">'+o.l+'</button>';});",
          "distHtml+='</div>';",

          "var ageHtml='<div class=\"dp-range-group\"><div class=\"dp-range-labels\"><span id=\"age-min-label\">'+(f.min_age||18)+'</span><span id=\"age-max-label\">'+(f.max_age||99)+'</span></div><div class=\"dp-range-track\"><div class=\"dp-range-fill\" id=\"age-fill\"></div><input type=\"range\" min=\"18\" max=\"99\" value=\"'+(f.min_age||18)+'\" id=\"age-min-input\"/><input type=\"range\" min=\"18\" max=\"99\" value=\"'+(f.max_age||99)+'\" id=\"age-max-input\"/></div></div>';",

          "var bodyTypes=['slim','athletic','average','muscular','stocky','bear'];",
          "var btHtml='<div class=\"dp-pill-group\">';",
          "bodyTypes.forEach(function(bt){var active=(f.body_type||[]).indexOf(bt)>=0;btHtml+='<label class=\"dp-check-pill'+(active?' dp-pill-active':'')+'\" data-pill=\"body_type\" data-val=\"'+bt+'\"><input type=\"checkbox\"'+(active?' checked':'')+'/> '+pinTagLabel(bt)+'</label>';});",
          "btHtml+='</div>';",

          "var positions=['top','bottom','vers','side'];",
          "var posHtml='<div class=\"dp-pill-group\">';",
          "positions.forEach(function(p){var active=(f.position||[]).indexOf(p)>=0;posHtml+='<label class=\"dp-check-pill'+(active?' dp-pill-active':'')+'\" data-pill=\"position\" data-val=\"'+p+'\"><input type=\"checkbox\"'+(active?' checked':'')+'/> '+pinTagLabel(p)+'</label>';});",
          "posHtml+='</div>';",

          "var tribes=['bear','twink','jock','otter','daddy','wolf','cub','geek','rugged'];",
          "var tribeHtml='<div class=\"dp-pill-group\">';",
          "tribes.forEach(function(t){var active=(f.tribe||[]).indexOf(t)>=0;tribeHtml+='<label class=\"dp-check-pill'+(active?' dp-pill-active':'')+'\" data-pill=\"tribe\" data-val=\"'+t+'\"><input type=\"checkbox\"'+(active?' checked':'')+'/> '+pinTagLabel(t)+'</label>';});",
          "tribeHtml+='</div>';",

          "panel.innerHTML='<div class=\"dp-filter-header\"><h3>Filters</h3><button type=\"button\" class=\"dp-filter-close\"></button></div>'",
            "+'<div class=\"dp-filter-section\"><h4>Distance</h4>'+distHtml+'</div>'",
            "+'<div class=\"dp-filter-section\"><h4>Age range</h4>'+ageHtml+'</div>'",
            "+'<div class=\"dp-filter-section\"><h4>Body type</h4>'+btHtml+'</div>'",
            "+'<div class=\"dp-filter-section\"><h4>Position</h4>'+posHtml+'</div>'",
            "+'<div class=\"dp-filter-section\"><h4>Tribe</h4>'+tribeHtml+'</div>'",
            "+'<div class=\"dp-filter-actions\"><button type=\"button\" class=\"dp-btn dp-btn-ghost\" id=\"filter-clear\">Clear all</button><button type=\"button\" class=\"dp-btn dp-btn-fire\" id=\"filter-apply\">Apply</button></div>';",

          "document.body.appendChild(backdrop);document.body.appendChild(panel);",
          "requestAnimationFrame(function(){backdrop.classList.add('dp-filter-open');panel.classList.add('dp-filter-open');});",

          # Close handlers
          "function closeFilter(){",
            "panel.classList.remove('dp-filter-open');backdrop.classList.remove('dp-filter-open');",
            "setTimeout(function(){if(backdrop.parentElement)backdrop.remove();if(panel.parentElement)panel.remove();},320);",
          "}",
          "backdrop.onclick=closeFilter;",
          "panel.querySelector('.dp-filter-close').onclick=closeFilter;",

          # Distance segments
          "panel.querySelectorAll('[data-dist]').forEach(function(btn){",
            "btn.onclick=function(){",
              "panel.querySelectorAll('[data-dist]').forEach(function(b){b.classList.remove('dp-seg-active');});",
              "btn.classList.add('dp-seg-active');",
            "};",
          "});",

          # Age range
          "var ageMin=panel.querySelector('#age-min-input');",
          "var ageMax=panel.querySelector('#age-max-input');",
          "var ageMinLbl=panel.querySelector('#age-min-label');",
          "var ageMaxLbl=panel.querySelector('#age-max-label');",
          "var ageFill=panel.querySelector('#age-fill');",
          "function updateAgeFill(){",
            "var lo=parseInt(ageMin.value);var hi=parseInt(ageMax.value);",
            "if(lo>hi){var tmp=lo;lo=hi;hi=tmp;}",
            "ageMinLbl.textContent=lo;ageMaxLbl.textContent=hi;",
            "var pctL=((lo-18)/81)*100;var pctR=((hi-18)/81)*100;",
            "ageFill.style.left=pctL+'%';ageFill.style.width=(pctR-pctL)+'%';",
          "}",
          "if(ageMin)ageMin.oninput=updateAgeFill;",
          "if(ageMax)ageMax.oninput=updateAgeFill;",
          "updateAgeFill();",

          # Pill toggles
          "panel.querySelectorAll('.dp-check-pill').forEach(function(pill){",
            "var cb=pill.querySelector('input');",
            "pill.onclick=function(e){",
              "if(e.target===cb)return;",
              "cb.checked=!cb.checked;",
              "pill.classList.toggle('dp-pill-active',cb.checked);",
            "};",
            "cb.onchange=function(){pill.classList.toggle('dp-pill-active',cb.checked);};",
          "});",

          # Clear
          "panel.querySelector('#filter-clear').onclick=function(){",
            "setFilters({});closeFilter();pollNearby();",
          "};",

          # Apply
          "panel.querySelector('#filter-apply').onclick=function(){",
            "var newF={};",
            "var activeDist=panel.querySelector('[data-dist].dp-seg-active');",
            "if(activeDist&&activeDist.getAttribute('data-dist'))newF.max_distance=activeDist.getAttribute('data-dist');",
            "var lo=parseInt(ageMin.value);var hi=parseInt(ageMax.value);",
            "if(lo>hi){var tmp=lo;lo=hi;hi=tmp;}",
            "if(lo>18)newF.min_age=lo;",
            "if(hi<99)newF.max_age=hi;",
            "var bt=[];panel.querySelectorAll('[data-pill=\"body_type\"] input:checked').forEach(function(c){bt.push(c.parentElement.getAttribute('data-val'));});",
            "if(bt.length)newF.body_type=bt;",
            "var pos=[];panel.querySelectorAll('[data-pill=\"position\"] input:checked').forEach(function(c){pos.push(c.parentElement.getAttribute('data-val'));});",
            "if(pos.length)newF.position=pos;",
            "var tr=[];panel.querySelectorAll('[data-pill=\"tribe\"] input:checked').forEach(function(c){tr.push(c.parentElement.getAttribute('data-val'));});",
            "if(tr.length)newF.tribe=tr;",
            "setFilters(newF);closeFilter();pollNearby();",
          "};",
        "}",

        # Click handler for data-nav links (SPA navigation)
        "document.addEventListener('click',function(e){",
          "var a=e.target.closest('[data-nav]');",
          "if(!a)return;",
          "var href=a.getAttribute('href');",
          "if(!href||href.indexOf('http')===0)return;",
          "e.preventDefault();",
          "navigate(href);",
        "});",

        # Handle popstate for back/forward
        "window.addEventListener('popstate',function(){",
          "navigate(location.pathname,false);",
        "});",

        "function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML}",

        # Boot
        "applyTapFeedback();",
        "loadRoute(ROUTE,location.pathname);",
        "startUnreadPoll();",
      "}();"
    >>
  end
end
