name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  MIX_ENV: test
  ELIXIR_VERSION: "1.17.3"
  OTP_VERSION: "27.1"

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/elixir_workers
    steps:
      - uses: actions/checkout@v4

      - uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: |
            packages/elixir_workers/deps
            packages/elixir_workers/_build
          key: mix-${{ runner.os }}-${{ hashFiles('packages/elixir_workers/mix.exs') }}
          restore-keys: mix-${{ runner.os }}-

      - run: mix deps.get
      - run: mix format --check-formatted
      - run: mix compile --warnings-as-errors

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    defaults:
      run:
        working-directory: packages/elixir_workers
    steps:
      - uses: actions/checkout@v4

      - uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: |
            packages/elixir_workers/deps
            packages/elixir_workers/_build
          key: mix-${{ runner.os }}-${{ hashFiles('packages/elixir_workers/mix.exs') }}
          restore-keys: mix-${{ runner.os }}-

      - run: mix deps.get
      - run: mix test

  build:
    name: Build .avm
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Cache AtomVM WASM build
        uses: actions/cache@v4
        with:
          path: build/atomvm-wasi
          key: atomvm-wasm-${{ hashFiles('scripts/build-atomvm.sh', 'atomvm-wasi/**') }}

      - name: Cache stdlib
        uses: actions/cache@v4
        with:
          path: packages/elixir_workers/priv/stdlib
          key: stdlib-${{ hashFiles('vendor/AtomVM/libs/**') }}

      - name: Build AtomVM WASM + stdlib
        run: make priv

      - name: Generate starter project
        run: |
          make _build/starter
          cd _build/starter && mix elixir_workers.build

      - name: Verify build artifacts
        run: |
          test -f _build/starter/_build/worker/app.avm || { echo "app.avm not found"; exit 1; }
          test -f _build/starter/_build/worker/atomvm.wasm || { echo "atomvm.wasm not found"; exit 1; }
          test -f _build/starter/_build/worker/src/index.js || { echo "index.js not found"; exit 1; }

      - name: Upload .avm artifact
        uses: actions/upload-artifact@v4
        with:
          name: worker-build
          path: |
            _build/starter/_build/worker/app.avm
            _build/starter/_build/worker/atomvm.wasm
            _build/starter/_build/worker/src/index.js
          retention-days: 7
